<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPE School - Mentor</title>
    <link rel="icon" type="image/png" href="/images/favicon.ico" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: 10px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .logo {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .profile-header:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }

        .profile-header img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #667eea;
        }

        .profile-info {
            display: flex;
            flex-direction: column;
        }

        .profile-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            line-height: 1.2;
        }

        .profile-phone {
            font-size: 12px;
            color: #666;
            line-height: 1.2;
        }

        .hamburger {
            display: flex;
            flex-direction: column;
            cursor: pointer;
            padding: 5px;
            gap: 3px;
        }

        .hamburger span {
            width: 25px;
            height: 3px;
            background-color: #333;
            transition: 0.3s;
            border-radius: 2px;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -100%;
            width: 280px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar.active {
            right: 0;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .close-sidebar {
            font-size: 24px;
            cursor: pointer;
            color: #666;
            transition: color 0.3s ease;
        }

        .close-sidebar:hover {
            color: #333;
        }

        .nav-section {
            margin-bottom: 25px;
        }

        .nav-section h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .nav-item:hover {
            background: #e9ecef;
            border-left-color: #667eea;
        }

        .nav-item.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-left-color: #fff;
        }

        .nav-item i {
            width: 16px;
            text-align: center;
        }

        .groups-section {
            margin-top: 20px;
        }

        .group-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .group-item:hover {
            background: #e9ecef;
        }

        .group-item.active {
            background: #d4edda;
            color: #155724;
            border-left: 3px solid #28a745;
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: calc(100vh - 120px);
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #dee2e6;
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #ff8c00);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .mentors-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .mentor-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            border: 1px solid #eee;
            cursor: pointer;
        }

        .mentor-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            background: #e9ecef;
        }

        .mentor-image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #667eea;
            flex-shrink: 0;
        }

        .mentor-info {
            flex: 1;
        }

        .mentor-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .mentor-phone {
            color: #666;
            font-size: 14px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .group-header {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .group-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .group-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .module-button {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 13px;
        }

        .module-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 15px;
            width: 95%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #333;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .custom-checkbox {
            display: block;
            position: relative;
            padding-left: 35px;
            margin-bottom: 15px;
            cursor: pointer;
            font-size: 16px;
            user-select: none;
            color: #333;
        }

        .custom-checkbox input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 22px;
            width: 22px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .custom-checkbox:hover input ~ .checkmark {
            background-color: #e9ecef;
            border-color: #667eea;
        }

        .custom-checkbox input:checked ~ .checkmark {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-color: transparent;
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .custom-checkbox input:checked ~ .checkmark:after {
            display: block;
        }

        .custom-checkbox .checkmark:after {
            left: 7px;
            top: 3px;
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .password-input-wrapper {
            position: relative;
        }

        .password-input-wrapper input {
            padding-right: 40px;
        }

        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .toggle-password:hover {
            color: #667eea;
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%;
            margin-bottom: 20px;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }

        .question-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #eee;
            transition: all 0.3s ease;
        }

        .question-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .question-text {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .variants-list {
            list-style: none;
            margin-bottom: 15px;
        }

        .variant-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 14px;
        }

        .correct-answer {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
            font-weight: 500;
        }

        .science-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .science-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .science-card:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .science-card.selected {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .modules-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .module-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #eee;
        }

        .module-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .module-card.selected {
            border-color: #28a745;
            background: #d4edda;
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .welcome-message i {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 20px;
        }

        .welcome-message h2 {
            color: #333;
            margin-bottom: 10px;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }

            .mentors-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }

            .mentor-card {
                flex-direction: column;
                text-align: center;
            }

            .mentor-image {
                width: 60px;
                height: 60px;
            }

            .group-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .group-actions {
                justify-content: flex-end;
            }

            .science-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }

            .modules-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }
    </style>
</head>
<body>
<div class="container">
    <header class="header">
        <div class="logo">
            <i class="fas fa-graduation-cap"></i> IPE School
        </div>

        <div class="profile-header" onclick="showView('profile')">
            <img id="headerProfileImage" src="/placeholder.svg?height=35&width=35" alt="Profile">
            <div class="profile-info">
                <div class="profile-name" id="headerProfileName">Loading...</div>
                <div class="profile-phone" id="headerProfilePhone">Loading...</div>
            </div>
        </div>

        <div class="hamburger" onclick="toggleSidebar()">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </header>

    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Menu</div>
            <div class="close-sidebar" onclick="closeSidebar()">×</div>
        </div>

        <div class="nav-section">
            <h3>Navigation</h3>
            <div class="nav-item" onclick="showView('mentors'); closeSidebar();">
                <i class="fas fa-users"></i>
                <span>All Mentors</span>
            </div>
            <div class="nav-item" onclick="showView('profile'); closeSidebar();">
                <i class="fas fa-user"></i>
                <span>My Profile</span>
            </div>
            <div class="nav-item" onclick="logout();">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </div>
        </div>

        <div class="nav-section">
            <h3>My Groups</h3>
            <div id="sidebarGroupsList">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading groups...
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <!-- Dashboard View -->
        <div id="dashboard" class="view active">
            <div class="welcome-message">
                <i class="fas fa-graduation-cap"></i>
                <h2>Welcome to IPE School</h2>
                <p>Select a group from the menu to view details, or use the navigation options.</p>
            </div>
        </div>

        <!-- Profile View -->
        <div id="profile" class="view">
            <h2>My Profile</h2>
            <form id="profileForm">
                <div class="form-group">
                    <label>Profile Image</label>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img id="profileImage" class="profile-image" src="/placeholder.svg?height=80&width=80"
                             alt="Profile" onclick="document.getElementById('imageInput').click()"
                             style="width: 120px; height: 120px; cursor: pointer;">
                        <input type="file" id="imageInput" accept="image/*" style="display: none;"
                               onchange="previewImage(this)">
                        <p style="color: #666; font-size: 12px; margin-top: 10px;">Click image to change</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="firstName">First Name</label>
                    <input type="text" id="firstName" required>
                </div>

                <div class="form-group">
                    <label for="lastName">Last Name</label>
                    <input type="text" id="lastName" required>
                </div>

                <div class="form-group">
                    <label for="phoneNumber">Phone Number</label>
                    <input type="tel" id="phoneNumber" required>
                </div>

                <div class="form-group">
                    <label class="custom-checkbox">
                        <input type="checkbox" id="changePassword" onchange="togglePasswordField()">
                        <span class="checkmark"></span>
                        <span class="label-text">Change Password</span>
                    </label>
                </div>

                <div class="form-group hidden" id="passwordGroup">
                    <label for="password">New Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="password" placeholder="Enter new password">
                        <i class="fas fa-eye-slash toggle-password" onclick="togglePasswordVisibility()"></i>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Update Profile
                </button>
            </form>
        </div>

        <!-- Mentors View -->
        <div id="mentors" class="view">
            <h2>All Mentors</h2>
            <div id="mentorsGrid" class="mentors-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading mentors...
                </div>
            </div>
        </div>

        <!-- Group Details View -->
        <div id="groupDetails" class="view">
            <div class="group-header">
                <h2 class="group-title" id="groupName">Group Details</h2>
                <div class="group-actions">
                    <button id="moduleButton" class="module-button hidden" onclick="showModuleDetails()">
                        <i class="fas fa-book"></i> <span id="moduleName">Module</span>
                    </button>
                    <button class="btn btn-warning" onclick="showChangeModuleModal()">
                        <i class="fas fa-exchange-alt"></i> Change Module
                    </button>
                    <button class="btn btn-secondary" onclick="showStudentProgress()">
                        <i class="fas fa-chart-line"></i> Progress
                    </button>
                </div>
            </div>

            <h3>Students</h3>
            <table class="table" id="studentsTable">
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Phone</th>
                </tr>
                </thead>
                <tbody id="studentsTableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Student Progress Modal -->
<div id="progressModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('progressModal')">&times;</span>
        <h2>Student Progress</h2>
        <div id="progressContent">
            <div class="loading">
                <div class="spinner"></div>
                Loading progress...
            </div>
        </div>
    </div>
</div>

<!-- Module Details Modal -->
<div id="moduleModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('moduleModal')">&times;</span>
        <h2 id="moduleModalTitle">Module Details</h2>
        <div id="moduleContent">
            <div class="loading">
                <div class="spinner"></div>
                Loading module...
            </div>
        </div>
    </div>
</div>

<!-- Task Details Modal -->
<div id="taskModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('taskModal')">&times;</span>
        <h2 id="taskModalTitle">Task Details</h2>
        <div id="taskContent">
            <div class="loading">
                <div class="spinner"></div>
                Loading task...
            </div>
        </div>
    </div>
</div>

<!-- Question Details Modal -->
<div id="questionModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('questionModal')">&times;</span>
        <h2 id="questionModalTitle">Question Details</h2>
        <div id="questionContent">
            <div class="loading">
                <div class="spinner"></div>
                Loading question...
            </div>
        </div>
    </div>
</div>

<!-- Change Module Modal -->
<div id="changeModuleModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('changeModuleModal')">&times;</span>
        <h2>Change Module</h2>
        <div id="changeModuleContent">
            <div class="loading">
                <div class="spinner"></div>
                Loading sciences...
            </div>
        </div>
        <div style="text-align: right; margin-top: 20px;">
            <button id="updateModuleBtn" class="btn btn-success hidden" onclick="updateGroupModule()">
                <i class="fas fa-save"></i> Update Module
            </button>
        </div>
    </div>
</div>

<!-- Mentor Groups Modal -->
<div id="mentorGroupsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('mentorGroupsModal')">&times;</span>
        <h2 id="mentorGroupsTitle">Mentor Groups</h2>
        <div id="mentorGroupsContent">
            <div class="loading">
                <div class="spinner"></div>
                Loading groups...
            </div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let currentUser = null;
    let currentGroupId = null;
    let currentModuleId = null;
    let selectedModuleId = null;
    let userData = JSON.parse(localStorage.getItem('userData')) || {};
    let allMentors = [];
    let mentorGroups = [];
    let allSciences = [];

    // 🔒 ROLE_MENTOR tekshiruvi
    if (!userData.roles || !userData.roles.includes("ROLE_MENTOR")) {
        alert("Sizga bu sahifaga kirish ruxsati yo'q!");
        localStorage.removeItem('userData');
        localStorage.removeItem('authToken');
        window.location.href = 'index.html';
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function () {
        loadUserData();
        loadMentorGroups();
        loadAllMentors();
        setupProfileForm();
    });

    // Toggle sidebar
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.sidebar-overlay');
        const hamburger = document.querySelector('.hamburger');

        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
        hamburger.classList.toggle('active');
    }

    // Close sidebar
    function closeSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.sidebar-overlay');
        const hamburger = document.querySelector('.hamburger');

        sidebar.classList.remove('active');
        overlay.classList.remove('active');
        hamburger.classList.remove('active');
    }

    // Load user data from localStorage
    function loadUserData() {
        const userData = localStorage.getItem('userData');
        if (!userData) {
            window.location.href = 'index.html';
            return;
        }

        currentUser = JSON.parse(userData);
        updateProfileDisplay();
    }

    // Update profile display
    function updateProfileDisplay() {
        if (!currentUser) return;

        // Update header profile
        document.getElementById('headerProfileName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
        document.getElementById('headerProfilePhone').textContent = currentUser.phoneNumber;

        if (currentUser.image) {
            document.getElementById('headerProfileImage').src = currentUser.image;
            document.getElementById('profileImage').src = currentUser.image;
        }

        // Update profile form
        document.getElementById('firstName').value = currentUser.firstName || '';
        document.getElementById('lastName').value = currentUser.lastName || '';
        document.getElementById('phoneNumber').value = currentUser.phoneNumber || '';
    }

    // Load mentor groups
    async function loadMentorGroups() {
        if (!currentUser || !currentUser.userId) return;

        try {
            const response = await fetch(`/api/v1/admin/mentor/${currentUser.userId}`);
            if (response.ok) {
                const mentorData = await response.json();
                mentorGroups = mentorData.groups || [];
                displaySidebarGroups();
            } else {
                console.error('Failed to load mentor groups');
            }
        } catch (error) {
            console.error('Error loading mentor groups:', error);
        }
    }

    // Display groups in sidebar
    function displaySidebarGroups() {
        const sidebarGroupsList = document.getElementById('sidebarGroupsList');

        if (mentorGroups.length === 0) {
            sidebarGroupsList.innerHTML = '<div style="text-align: center; color: #666; padding: 10px;">No groups assigned</div>';
            return;
        }

        sidebarGroupsList.innerHTML = mentorGroups.map(group => `
                <div class="group-item" onclick="selectGroup(${group.id}, '${group.name}')">
                    <i class="fas fa-users"></i>
                    <span>${group.name}</span>
                </div>
            `).join('');
    }

    // Select a group
    async function selectGroup(groupId, groupName) {
        currentGroupId = groupId;

        // Update active state
        document.querySelectorAll('.group-item').forEach(item => item.classList.remove('active'));
        event.target.classList.add('active');

        // Load group details
        await loadGroupDetails(groupId, groupName);
        showView('groupDetails');
        closeSidebar();
    }

    // Load group details
    async function loadGroupDetails(groupId, groupName) {
        try {
            const response = await fetch(`/api/v1/group/${groupId}`, {
                headers: {'Authorization': `${localStorage.getItem('authToken')}`}
            });
            if (response.ok) {
                const groupData = await response.json();
                displayGroupDetails(groupData);
            } else {
                console.error('Failed to load group details');
            }
        } catch (error) {
            console.error('Error loading group details:', error);
        }
    }

    // Display group details
    function displayGroupDetails(groupData) {
        document.getElementById('groupName').textContent = groupData.name;

        // Display module button if module exists
        if (groupData.modules && groupData.modules.length > 0) {
            const module = groupData.modules[0];
            currentModuleId = module.id;
            document.getElementById('moduleName').textContent = module.moduleName;
            document.getElementById('moduleButton').classList.remove('hidden');
        } else {
            document.getElementById('moduleButton').classList.add('hidden');
        }

        // Display students
        const studentsTableBody = document.getElementById('studentsTableBody');
        if (groupData.students && groupData.students.length > 0) {
            studentsTableBody.innerHTML = groupData.students.map(student => `
                    <tr>
                        <td>${student.firstName} ${student.lastName}</td>
                        <td>${student.phoneNumber}</td>
                    </tr>
                `).join('');
        } else {
            studentsTableBody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #666;">No students in this group</td></tr>';
        }
    }

    // Load all mentors
    async function loadAllMentors() {
        try {
            const response = await fetch('/api/v1/admin/mentor', {
                headers: {'Authorization': `${localStorage.getItem('authToken')}`}
            });
            if (response.ok) {
                allMentors = await response.json();
                displayMentors();
            } else {
                console.error('Failed to load mentors');
            }
        } catch (error) {
            console.error('Error loading mentors:', error);
        }
    }

    // Display mentors
    function displayMentors() {
        const mentorsGrid = document.getElementById('mentorsGrid');

        if (allMentors.length === 0) {
            mentorsGrid.innerHTML = '<div style="text-align: center; color: #666;">No mentors found</div>';
            return;
        }

        mentorsGrid.innerHTML = allMentors.map(mentor => `
                <div class="mentor-card" onclick="showMentorGroups(${mentor.id}, '${mentor.firstName} ${mentor.lastName}')">
                    <img class="mentor-image"
                         src="${mentor.image ? `data:image/jpeg;base64,${arrayBufferToBase64(mentor.image)}` : '/placeholder.svg?height=50&width=50'}"
                         alt="${mentor.firstName}">
                    <div class="mentor-info">
                        <div class="mentor-name">${mentor.firstName} ${mentor.lastName}</div>
                        <div class="mentor-phone">${mentor.phoneNumber}</div>
                    </div>
                </div>
            `).join('');
    }

    // Show mentor groups
    function showMentorGroups(mentorId, mentorName) {
        const mentor = allMentors.find(m => m.id === mentorId);
        if (!mentor) return;

        document.getElementById('mentorGroupsTitle').textContent = `${mentorName} - Groups`;
        document.getElementById('mentorGroupsModal').style.display = 'block';

        const mentorGroupsContent = document.getElementById('mentorGroupsContent');

        if (!mentor.groups || mentor.groups.length === 0) {
            mentorGroupsContent.innerHTML = '<p style="text-align: center; color: #666;">No groups assigned to this mentor</p>';
            return;
        }

        mentorGroupsContent.innerHTML = `
                <div class="mentors-grid">
                    ${mentor.groups.map(group => `
                        <div class="mentor-card" style="cursor: default;">
                            <i class="fas fa-users" style="font-size: 24px; color: #667eea; margin-right: 10px;"></i>
                            <div class="mentor-info">
                                <div class="mentor-name">${group.name}</div>
                                <div class="mentor-phone">Group ID: ${group.id}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
    }

    // Show student progress
    async function showStudentProgress() {
        if (!currentGroupId) return;

        document.getElementById('progressModal').style.display = 'block';
        document.getElementById('progressContent').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Loading progress...
                </div>
            `;

        try {
            const response = await fetch(`/api/v1/group/getProgress/${currentGroupId}`, {
                headers: {'Authorization': `${localStorage.getItem('authToken')}`}
            });
            if (response.ok) {
                const progressData = await response.json();
                displayStudentProgress(progressData);
            } else {
                console.error('Failed to load student progress');
            }
        } catch (error) {
            console.error('Error loading student progress:', error);
        }
    }

    // Display student progress
    function displayStudentProgress(progressData) {
        const progressContent = document.getElementById('progressContent');

        if (progressData.length === 0) {
            progressContent.innerHTML = '<p style="text-align: center; color: #666;">No progress data available</p>';
            return;
        }

        progressContent.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Total</th>
                            <th>Passed</th>
                            <th>Progress</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${progressData.map(student => `
                            <tr>
                                <td>${student.studentName}</td>
                                <td>${student.totalQuery}</td>
                                <td>${student.passedQuery}</td>
                                <td>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${student.progress}%"></div>
                                    </div>
                                    <span style="font-size: 12px; color: #666;">${student.progress}%</span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
    }

    // Show change module modal
    async function showChangeModuleModal() {
        if (!currentGroupId) return;

        document.getElementById('changeModuleModal').style.display = 'block';
        document.getElementById('changeModuleContent').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Loading sciences...
                </div>
            `;

        try {
            const response = await fetch('/api/v1/science', {
                headers: {'Authorization': `${localStorage.getItem('authToken')}`}
            });
            if (response.ok) {
                allSciences = await response.json();
                displaySciences();
            } else {
                console.error('Failed to load sciences');
            }
        } catch (error) {
            console.error('Error loading sciences:', error);
        }
    }

    // Display sciences
    function displaySciences() {
        const changeModuleContent = document.getElementById('changeModuleContent');

        if (allSciences.length === 0) {
            changeModuleContent.innerHTML = '<p style="text-align: center; color: #666;">No sciences available</p>';
            return;
        }

        changeModuleContent.innerHTML = `
    <h3>Select a Science:</h3>
    <div class="science-grid">
        ${allSciences.map(science => {
            const activeModuleCount = science.modules
                ? science.modules.filter(module => module.active).length
                : 0;

            return `
                <div class="science-card" onclick="selectScience(${science.id}, '${science.name}')">
                    <i class="fas fa-flask" style="font-size: 24px; margin-bottom: 10px;"></i>
                    <h4>${science.name}</h4>
                    <p style="font-size: 12px; color: #666;">${activeModuleCount} modules</p>
                </div>
            `;
        }).join('')}
    </div>
    <div id="modulesSection" class="hidden">
        <h3>Select a Module:</h3>
        <div id="modulesGrid" class="modules-grid"></div>
    </div>
`;
    }

    // Select science
    function selectScience(scienceId, scienceName) {
        // Update selected state
        document.querySelectorAll('.science-card').forEach(card => card.classList.remove('selected'));
        event.target.classList.add('selected');

        const science = allSciences.find(s => s.id === scienceId);
        if (!science || !science.modules) return;

        // Show modules section
        document.getElementById('modulesSection').classList.remove('hidden');
        const modulesGrid = document.getElementById('modulesGrid');

        modulesGrid.innerHTML = science.modules
            .filter(module => module.active) // faqat active modullar
            .map(module => `
        <div class="module-card" onclick="selectModule(${module.id}, '${module.name}')">
            <h4>${module.name}</h4>
            <p style="color: #666; font-size: 14px;">Module ID: ${module.id}</p>
        </div>
    `)
            .join('');

    }

    // Select module
    function selectModule(moduleId, moduleName) {
        selectedModuleId = moduleId;

        // Update selected state
        document.querySelectorAll('.module-card').forEach(card => card.classList.remove('selected'));
        event.target.classList.add('selected');

        // Show update button
        document.getElementById('updateModuleBtn').classList.remove('hidden');
    }

    // Update group module
    async function updateGroupModule() {
        if (!currentGroupId || !selectedModuleId) return;

        try {
            const response = await fetch(`/api/v1/group/updateModule/${currentGroupId}`, {
                method: 'POST',
                headers: {
                    'Authorization': `${localStorage.getItem('authToken')}`,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `moduleId=${selectedModuleId}`
            });

            if (response.ok) {
                alert('Module updated successfully!');
                closeModal('changeModuleModal');
                // Reload group details
                await loadGroupDetails(currentGroupId, document.getElementById('groupName').textContent);
            } else {
                alert('Failed to update module');
            }
        } catch (error) {
            console.error('Error updating module:', error);
            alert('Error updating module');
        }
    }

    // Show module details
    async function showModuleDetails() {
        if (!currentModuleId) return;

        document.getElementById('moduleModal').style.display = 'block';
        document.getElementById('moduleContent').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Loading module...
                </div>
            `;

        try {
            const response = await fetch(`/api/v1/module/${currentModuleId}`, {
                headers: {'Authorization': `${localStorage.getItem('authToken')}`}
            });
            if (response.ok) {
                const moduleData = await response.json();
                displayModuleDetails(moduleData);
            } else {
                console.error('Failed to load module details');
            }
        } catch (error) {
            console.error('Error loading module details:', error);
        }
    }

    // Display module details
    function displayModuleDetails(moduleData) {
        document.getElementById('moduleModalTitle').textContent = moduleData.moduleName;
        const moduleContent = document.getElementById('moduleContent');

        if (!moduleData.tasks || moduleData.tasks.length === 0) {
            moduleContent.innerHTML = '<p style="text-align: center; color: #666;">No tasks available</p>';
            return;
        }

        const activeTasks = moduleData.tasks.filter(task => task.active);

        if (activeTasks.length === 0) {
            moduleContent.innerHTML = '<p style="text-align: center; color: #666;">No active tasks available</p>';
            return;
        }

        moduleContent.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Task Name</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                ${activeTasks.map(task => `
                    <tr>
                        <td>${task.taskName}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="showTaskDetails(${task.id}, '${task.taskName}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    }

    // Show task details
    async function showTaskDetails(taskId, taskName) {
        document.getElementById('taskModal').style.display = 'block';
        document.getElementById('taskModalTitle').textContent = taskName;
        document.getElementById('taskContent').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Loading task...
                </div>
            `;

        try {
            const response = await fetch(`/api/v1/task/${taskId}`, {
                headers: {'Authorization': `${localStorage.getItem('authToken')}`}
            });
            if (response.ok) {
                const taskData = await response.json();
                await displayTaskDetails(taskData);
            } else {
                console.error('Failed to load task details');
            }
        } catch (error) {
            console.error('Error loading task details:', error);
        }
    }

    // Display task details
    async function displayTaskDetails(taskData) {
        const taskContent = document.getElementById('taskContent');
        let content = '';

        // YouTube video
        if (taskData.youtubeURL) {
            const videoId = extractYouTubeVideoId(taskData.youtubeURL);
            if (videoId) {
                content += `
                        <div class="video-container">
                            <iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>
                        </div>
                    `;
            }
        }

        // Attachments
        if (taskData.attachmentId && taskData.attachmentId.length > 0) {
            content += '<h4>Attachments:</h4><div>';
            for (const attachmentId of taskData.attachmentId) {
                try {
                    const attachmentResponse = await fetch(`/api/v1/attachments/${attachmentId}`, {
                        headers: {
                            'Authorization': localStorage.getItem('authToken')
                        }
                    });

                    if (attachmentResponse.ok) {
                        const attachmentData = await attachmentResponse.json();
                        const attachmentUrl = `data:${attachmentData.contentType};base64,${arrayBufferToBase64(attachmentData.content)}`;
                        content += `<img src="${attachmentUrl}"
                               style="max-width: 100%; margin: 10px 0; border-radius: 8px;"
                               alt="Attachment">`;
                    }
                } catch (error) {
                    console.error('Error loading attachment:', error);
                }
            }
            content += '</div>';
        }

        // Questions
        if (taskData.questionRes && taskData.questionRes.length > 0) {
            content += '<h4>Questions:</h4>';
            content += '<table class="table">';
            content += '<thead><tr><th>Question</th><th>Action</th></tr></thead>';
            content += '<tbody>';

            taskData.questionRes.forEach((question, index) => {
                content += `
                        <tr>
                            <td>Question ${index + 1}: ${question.questionTest || 'Question details'}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="showQuestionDetails(${JSON.stringify(question).replace(/"/g, '&quot;')}, ${index + 1})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>
                    `;
            });

            content += '</tbody></table>';
        }

        if (!content) {
            content = '<p style="text-align: center; color: #666;">No additional content available</p>';
        }

        taskContent.innerHTML = content;
    }

    // Show question details
    async function showQuestionDetails(question, questionNumber) {
        document.getElementById('questionModal').style.display = 'block';
        document.getElementById('questionModalTitle').textContent = `Question ${questionNumber}`;
        document.getElementById('questionContent').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Loading question details...
                </div>
            `;

        let content = '';

        // Question text
        content += `<div class="question-card">`;
        content += `<div class="question-text"><strong>Question:</strong> ${question.questionTest || 'No question text available'}</div>`;

        // Question attachment
        if (question.attachmentId) {
            try {
                const attachmentResponse = await fetch(`/api/v1/attachments/${question.attachmentId}`, {
                    headers: {
                        'Authorization': localStorage.getItem('authToken')
                    }
                });

                if (attachmentResponse.ok) {
                    const attachmentData = await attachmentResponse.json();
                    const attachmentUrl = `data:${attachmentData.contentType};base64,${arrayBufferToBase64(attachmentData.content)}`;
                    content += `
                            <div style="margin: 15px 0;">
                                <strong>Question Image:</strong><br>
                                <img src="${attachmentUrl}" style="max-width: 100%; margin-top: 10px; border-radius: 8px;" alt="Question Image">
                            </div>
                        `;
                }
            } catch (error) {
                console.error('Error loading question attachment:', error);
            }
        }

        // Variants
        if (question.variant && question.variant.length > 0) {
            content += `<div style="margin: 15px 0;"><strong>Options:</strong></div>`;
            content += `<ul class="variants-list">`;
            question.variant.forEach((variant, index) => {
                const isCorrect = variant === question.currentAnswer;
                content += `<li class="variant-item ${isCorrect ? 'correct-answer' : ''}">${String.fromCharCode(65 + index)}. ${variant}</li>`;
            });
            content += `</ul>`;
        }

        // Correct answer
        if (question.currentAnswer) {
            content += `<div style="margin: 15px 0;"><strong>Correct Answer:</strong> <span style="color: #28a745; font-weight: 600;">${question.currentAnswer}</span></div>`;
        }

        content += `</div>`;

        document.getElementById('questionContent').innerHTML = content;
    }

    // Setup profile form
    function setupProfileForm() {
        document.getElementById('profileForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            await updateProfile();
        });
    }

    // Update profile
    async function updateProfile() {
        const formData = new FormData();
        formData.append('id', currentUser.userId.toString());
        formData.append('firstName', document.getElementById('firstName').value);
        formData.append('lastName', document.getElementById('lastName').value);
        formData.append('phoneNumber', document.getElementById('phoneNumber').value);

        // Add password if changing
        if (document.getElementById('changePassword').checked) {
            const password = document.getElementById('password').value;
            if (password) {
                formData.append('password', password);
            }
        }

        // Add image if selected
        const imageInput = document.getElementById('imageInput');
        if (imageInput.files[0]) {
            formData.append('file', imageInput.files[0]);
        }

        try {
            const response = await fetch('/api/v1/auth/updateProfile', {
                headers: {'Authorization': `${localStorage.getItem('authToken')}`},
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const updatedData = await response.json();

                // Update localStorage (preserve roles and token)
                const currentUserData = JSON.parse(localStorage.getItem('userData'));
                const updatedUserData = {
                    ...currentUserData,
                    firstName: updatedData.firstName,
                    lastName: updatedData.lastName,
                    phoneNumber: updatedData.phoneNumber,
                    image: updatedData.image || currentUserData.image
                };

                localStorage.setItem('userData', JSON.stringify(updatedUserData));
                currentUser = updatedUserData;

                updateProfileDisplay();
                alert('Profile updated successfully!');

                // Reset password fields
                document.getElementById('changePassword').checked = false;
                document.getElementById('password').value = '';
                togglePasswordField();
            } else {
                alert('Failed to update profile');
            }
        } catch (error) {
            console.error('Error updating profile:', error);
            alert('Error updating profile');
        }
    }

    // Preview image
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('profileImage').src = e.target.result;
                document.getElementById('headerProfileImage').src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Toggle password field
    function togglePasswordField() {
        const passwordGroup = document.getElementById('passwordGroup');
        const changePassword = document.getElementById('changePassword');

        if (changePassword.checked) {
            passwordGroup.classList.remove('hidden');
            document.getElementById('password').required = true;
        } else {
            passwordGroup.classList.add('hidden');
            document.getElementById('password').required = false;
            document.getElementById('password').value = '';
        }
    }

    // Show view
    function showView(viewName) {
        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        document.getElementById(viewName).classList.add('active');
    }

    // Close modal
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';

        // Reset change module modal state
        if (modalId === 'changeModuleModal') {
            selectedModuleId = null;
            document.getElementById('updateModuleBtn').classList.add('hidden');
        }
    }

    // Logout function
    function logout() {
        if (!currentUser || !currentUser.roles) {
            localStorage.removeItem('userData');
            window.location.href = 'index.html';
            return;
        }

        if (currentUser.roles.length === 1) {
            localStorage.removeItem('userData');
            window.location.href = 'index.html';
        } else {
            window.location.href = 'chooseRole.html';
        }
    }

    // Utility functions
    function arrayBufferToBase64(buffer) {
        if (!buffer) return '';
        if (typeof buffer === 'string') return buffer;

        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
    }

    function extractYouTubeVideoId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    function togglePasswordVisibility() {
        const passwordInput = document.getElementById('password');
        const toggleIcon = document.querySelector('.toggle-password');

        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleIcon.classList.remove('fa-eye-slash');
            toggleIcon.classList.add('fa-eye');
        } else {
            passwordInput.type = 'password';
            toggleIcon.classList.remove('fa-eye');
            toggleIcon.classList.add('fa-eye-slash');
        }
    }

    // Close modals when clicking outside
    window.onclick = function (event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    }
</script>
</body>
</html>
