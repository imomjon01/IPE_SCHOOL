<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mentor Cabinet - IPE School</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
        }
        .header-bg {
            background: linear-gradient(90deg, #1e3a8a, #3b82f6);
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        #close-module-button {
            display: none;
        }
        #close-module-button.visible {
            display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-100">
<header class="header-bg text-white py-4">
    <div class="container mx-auto px-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold">IPE School</h1>
        <nav>
            <ul class="flex space-x-6">
                <li><a href="/index.html" class="hover:underline">Home</a></li>
                <li><a href="/about" class="hover:underline">About</a></li>
                <li><a href="/mentors" class="hover:underline">Mentors</a></li>
                <li><a href="/logout" class="hover:underline">Logout</a></li>
            </ul>
        </nav>
    </div>
</header>

<main class="container mx-auto px-4 py-8">
    <section class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <div id="mentor-profile" class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Mentor Profile</h2>
            <div class="flex items-center space-x-6 mb-4">
                <img id="profile-picture" src="" alt="Mentor Image" class="w-24 h-24 rounded-full object-cover border-4 border-blue-500">
                <div>
                    <h3 id="profile-name" class="text-xl font-semibold text-gray-800"></h3>
                    <p id="profile-phone" class="text-gray-600"></p>
                </div>
            </div>
            <button id="edit-profile-button" class="bg-yellow-500 text-white p-2 rounded">Edit Profile</button>
            <div id="edit-profile-form" class="hidden mt-4">
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Edit Profile</h3>
                <div class="mb-4">
                    <label for="update-first-name" class="block text-gray-700">First Name</label>
                    <input type="text" id="update-first-name" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-4">
                    <label for="update-last-name" class="block text-gray-700">Last Name</label>
                    <input type="text" id="update-last-name" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-4">
                    <label for="update-profile-phone" class="block text-gray-700">Phone Number</label>
                    <input type="text" id="update-profile-phone" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-4">
                    <label for="update-profile-picture" class="block text-gray-700">Profile Picture</label>
                    <input type="file" id="update-profile-picture" class="w-full p-2 border rounded">
                </div>
                <div class="flex space-x-2">
                    <button id="cancel-profile-update" class="bg-gray-500 text-white p-2 rounded">Cancel</button>
                    <button id="submit-profile-update" class="bg-blue-500 text-white p-2 rounded">Update Profile</button>
                </div>
            </div>
        </div>
        <h2 class="text-3xl font-semibold text-gray-800 mb-4">Mentor Dashboard</h2>
        <p class="text-gray-600 mb-6">Welcome to your mentor cabinet. Below are the groups you are mentoring.</p>

        <div id="groups-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div id="group-details" class="hidden mt-8">
            <button id="back-to-groups" class="bg-blue-500 text-white p-2 rounded mb-4">Back to Groups</button>
            <h2 id="group-name" class="text-2xl font-semibold text-gray-800 mb-4"></h2>
            <div class="mb-6">
                <h3 class="text-xl font-semibold text-gray-800">Students</h3>
                <div id="students-list" class="mt-2"></div>
            </div>
            <div>
                <h3 class="text-xl font-semibold text-gray-800">Modules</h3>
                <p id="modules-warning" class="text-yellow-600 mt-2 hidden"></p>
                <div id="modules-list" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
        </div>

        <div id="module-details" class="hidden mt-8">
            <button id="back-to-group" class="bg-blue-500 text-white p-2 rounded mb-4">Back to Group</button>
            <h2 id="module-name" class="text-2xl font-semibold text-gray-800 mb-4"></h2>
            <div class="mb-4 flex space-x-2">
                <button id="add-task-button" class="bg-green-500 text-white p-2 rounded">Add Task +</button>
                <button id="close-module-button" class="bg-red-500 text-white p-2 rounded">Close Module</button>
            </div>
            <div>
                <h3 class="text-xl font-semibold text-gray-800">Tasks</h3>
                <div id="add-task-form" class="hidden mt-4">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Add New Task</h3>
                    <div class="mb-4">
                        <label for="task-name" class="block text-gray-700">Task Name</label>
                        <input type="text" id="task-name" class="w-full p-2 border rounded" required>
                    </div>
                    <div class="mb-4">
                        <label for="youtube-url" class="block text-gray-700">YouTube URL</label>
                        <input type="text" id="youtube-url" class="w-full p-2 border rounded">
                    </div>
                    <div class="mb-4">
                        <label for="attachments" class="block text-gray-700">Attachments</label>
                        <input type="file" id="attachments" name="attachments" multiple class="w-full p-2 border rounded">
                    </div>
                    <button id="submit-task" class="bg-blue-500 text-white p-2 rounded">Add Task</button>
                </div>
                <div id="tasks-list" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
        </div>

        <div id="task-details" class="hidden mt-8">
            <button id="back-to-module" class="bg-blue-500 text-white p-2 rounded mb-4">Back to Module</button>
            <h2 id="task-name" class="text-2xl font-semibold text-gray-800 mb-4"></h2>
            <div id="task-video" class="mb-6"></div>
            <div id="task-attachments" class="mb-6">
                <h3 class="text-xl font-semibold text-gray-800">Attachments</h3>
                <div id="attachments-list" class="mt-2"></div>
            </div>
            <div>
                <h3 class="text-xl font-semibold text-gray-800">Questions</h3>
                <button id="add-question-button" class="bg-green-500 text-white p-2 rounded mb-4">Add Question +</button>
                <div id="add-question-form" class="hidden mt-4">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Add New Question</h3>
                    <div class="mb-4">
                        <label for="question-test" class="block text-gray-700">Question Text</label>
                        <input type="text" id="question-test" class="w-full p-2 border rounded" required>
                    </div>
                    <div class="mb-4">
                        <label for="question-attachment" class="block text-gray-700">Attachment (Optional)</label>
                        <input type="file" id="question-attachment" class="w-full p-2 border rounded">
                    </div>
                    <div class="mb-4">
                        <h4 class="block text-gray-700 font-semibold">Answer Variants</h4>
                        <div id="variants-container" class="mt-2"></div>
                        <button id="add-variant-button" class="bg-blue-500 text-white p-2 rounded mt-2">+ Add Variant</button>
                    </div>
                    <button id="submit-question" class="bg-blue-500 text-white p-2 rounded">Add Question</button>
                </div>
                <div id="questions-list" class="mt-2"></div>
            </div>
            <button id="update-task-button" class="bg-yellow-500 text-white p-2 rounded mb-4">Update Task</button>
            <div id="update-task-form" class="hidden mt-4">
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Update Task</h3>
                <div class="mb-4">
                    <label for="update-task-name" class="block text-gray-700">Task Name</label>
                    <input type="text" id="update-task-name" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-4">
                    <label for="update-youtube-url" class="block text-gray-700">YouTube URL</label>
                    <input type="text" id="update-youtube-url" class="w-full p-2 border rounded">
                </div>
                <div class="mb-4">
                    <label for="update-attachments" class="block text-gray-700">Attachments</label>
                    <input type="file" id="update-attachments" name="attachments" multiple class="w-full p-2 border rounded">
                </div>
                <button id="submit-update-task" class="bg-blue-500 text-white p-2 rounded">Update Task</button>
            </div>
        </div>
    </section>
</main>

<footer class="bg-gray-800 text-white py-6">
    <div class="container mx-auto px-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <h3 class="text-lg font-semibold">About Us</h3>
                <p class="text-sm">IPE School is a leading educational institution dedicated to providing quality education with expert mentors and modern facilities.</p>
            </div>
            <div>
                <h3 class="text-lg font-semibold">Quick Links</h3>
                <ul class="text-sm">
                    <li><a href="/index.html" class="hover:underline">Home</a></li>
                    <li><a href="/about" class="hover:underline">About</a></li>
                    <li><a href="/mentors" class="hover:underline">Mentors</a></li>
                    <li><a href="/login.html" class="hover:underline">Login</a></li>
                </ul>
            </div>
            <div>
                <h3 class="text-lg font-semibold">Contact Info</h3>
                <p class="text-sm">123 Education Street, Tashkent</p>
                <p class="text-sm">+998 90 123 45 67</p>
                <p class="text-sm">info@ipeschool.com</p>
            </div>
        </div>
        <p class="text-center text-sm mt-6">© 2023 IPE School. All Rights Reserved.</p>
    </div>
</footer>

<script>
    const BASE_URL = 'http://localhost:';
    let currentGroup = null;
    let currentModule = null;
    let currentTaskId = null;
    let currentTask = null;

    function byteArrayToDataUrl(byteArray, mime = 'application/octet-stream') {
        const uint8 = new Uint8Array(byteArray);
        let binary = '';
        for (let i = 0; i < uint8.length; i++) {
            binary += String.fromCharCode(uint8[i]);
        }
        return `data:${mime};base64,${window.btoa(binary)}`;
    }

    function getImageSrc(imageData) {
        if (Array.isArray(imageData) && imageData.length) {
            return byteArrayToDataUrl(imageData, 'image/png');
        } else if (typeof imageData === 'string' && imageData.startsWith('data:image')) {
            return imageData;
        }
        return 'https://via.placeholder.com/100';
    }

    function getAuthHeader() {
        let token = localStorage.getItem('authToken');
        if (!token) {
            console.error('No auth token found in localStorage. Redirecting to login.');
            return null;
        }
        try {
            if (typeof token === 'string' && token.startsWith('{')) {
                token = JSON.parse(token).token || token;
            }
        } catch (e) {
            console.warn('Invalid token format in localStorage:', e.message);
        }
        const cleanToken = token.startsWith('Bearer ') ? token.substring(7) : token;
        console.debug('Using auth token (obfuscated): Bearer ' + cleanToken.slice(0, 4) + '...');
        return `Bearer ${cleanToken}`;
    }

    async function fetchWithAuth(url, options = {}) {
        const authHeader = getAuthHeader();
        if (!authHeader) {
            alert('No authentication token found. Please log in again.');
            window.location.href = '/login.html';
            throw new Error('No authentication token');
        }

        console.debug(`Making request to ${BASE_URL}${url}`, {
            method: options.method || 'GET',
            headers: { Authorization: authHeader, ...options.headers }
        });

        try {
            const headers = {
                ...options.headers,
                Authorization: authHeader
            };
            if (!(options.body instanceof FormData)) {
                headers['Content-Type'] = options.headers?.['Content-Type'] || 'application/json';
            }

            const response = await fetch(`${BASE_URL}${url}`, {
                ...options,
                headers
            });

            console.debug(`Response from ${BASE_URL}${url}: ${response.status} ${response.statusText}`);

            if (response.status === 401) {
                console.error('Unauthorized request. Token may be invalid or expired.');
                alert('Session expired or invalid token. Please log in again.');
                localStorage.removeItem('authToken');
                window.location.href = '/login.html';
                throw new Error('Unauthorized');
            }

            if (!response.ok) {
                // Read response body once
                const contentType = response.headers.get('content-type');
                let errorText = 'Unknown error';
                let responseBody;

                try {
                    responseBody = await response.text();
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = JSON.parse(responseBody);
                        errorText = errorData.message || errorText;
                    } else {
                        errorText = responseBody || errorText;
                    }
                } catch (e) {
                    console.warn('Failed to parse response body:', e.message);
                    errorText = responseBody || 'Unable to read error details';
                }

                throw new Error(`Failed to fetch: ${response.status} - ${errorText}`);
            }

            return response;
        } catch (error) {
            console.error(`Fetch error for ${BASE_URL}${url}:`, error.message);
            throw error;
        }
    }

    async function createAttachment(file) {
        if (!file || file.size === 0) {
            throw new Error('No file selected or file is empty');
        }
        if (file.size > 5 * 1024 * 1024) {
            throw new Error('File size exceeds 5MB limit');
        }
        const formData = new FormData();
        formData.append('attachment', file);
        console.debug('Uploading attachment:', { fileName: file.name, size: file.size });
        try {
            const response = await fetchWithAuth('/api/v1/attachments', {
                method: 'POST',
                headers: {},
                body: formData
            });
            const data = await response.json();
            console.debug('Attachment uploaded successfully:', data);
            return { id: data };
        } catch (error) {
            console.error('Attachment upload failed:', error);
            throw error;
        }
    }

    async function updateProfile() {
        const firstName = document.getElementById('update-first-name').value;
        const lastName = document.getElementById('update-last-name').value;
        const phoneNumber = document.getElementById('update-profile-phone').value;
        const profilePicture = document.getElementById('update-profile-picture').files[0];

        if (!firstName || !lastName || !phoneNumber) {
            alert('Please fill in all required fields.');
            return;
        }

        let attachmentId = null;
        if (profilePicture) {
            try {
                const attachmentData = await createAttachment(profilePicture);
                attachmentId = attachmentData.id;
                if (!attachmentId) {
                    throw new Error('No attachment ID received from server');
                }
                console.debug('Profile picture uploaded:', { attachmentId });
            } catch (error) {
                console.error('Profile picture upload error:', error);
                alert(`Failed to upload profile picture: ${error.message}. Please try again.`);
                return;
            }
        }

        const formData = new FormData();
        formData.append('firstName', firstName);
        formData.append('lastName', lastName);
        formData.append('phoneNumber', phoneNumber);
        if (attachmentId) {
            formData.append('image', attachmentId.toString());
        }

        try {
            console.debug('Sending profile update:', Object.fromEntries(formData));
            const response = await fetchWithAuth('/api/v1/mentor/profile', {
                method: 'PUT',
                headers: {},
                body: formData
            });
            const updatedUser = await response.json();
            console.debug('Profile updated successfully:', updatedUser);

            localStorage.setItem('userData', JSON.stringify(updatedUser));
            displayMentorProfile();
            document.getElementById('edit-profile-form').classList.add('hidden');
            alert('Profile updated successfully!');
        } catch (error) {
            console.error('Error updating profile:', {
                message: error.message,
                stack: error.stack,
                formData: Object.fromEntries(formData)
            });
            alert(`An error occurred while updating the profile: ${error.message}`);
        }
    }

    function addVariantInput(container, index) {
        const variantDiv = document.createElement('div');
        variantDiv.className = 'flex items-center space-x-2 mb-2';
        variantDiv.innerHTML = `
            <input type="text" id="variant-${index}" class="flex-1 p-2 border rounded" placeholder="Enter variant ${index + 1}" required>
            <label class="flex items-center space-x-1">
                <input type="checkbox" id="correct-${index}" class="form-checkbox">
                <span>Correct</span>
            </label>
            <button type="button" class="bg-red-500 text-white p-2 rounded hover:bg-red-600 remove-variant">Remove</button>
        `;
        container.appendChild(variantDiv);
        variantDiv.querySelector('.remove-variant').addEventListener('click', () => {
            variantDiv.remove();
        });
    }

    function displayMentorProfile() {
        const userData = JSON.parse(localStorage.getItem('userData'));
        if (!userData) {
            console.warn('No user data found in localStorage');
            return;
        }

        const profilePicture = document.getElementById('profile-picture');
        const profileName = document.getElementById('profile-name');
        const profilePhone = document.getElementById('profile-phone');

        const imageSrc = getImageSrc(userData.image);
        profilePicture.src = imageSrc;
        profileName.textContent = `${userData.firstName} ${userData.lastName}`;
        profilePhone.textContent = `Phone: ${userData.phoneNumber}`;
    }

    async function fetchMentorGroups() {
        const token = localStorage.getItem('authToken');
        if (!token) {
            console.error('No auth token found. Redirecting to login.');
            alert('Please log in to view your groups.');
            window.location.href = '/login.html';
            return;
        }
        console.debug('Fetching groups with token (obfuscated): ' + token.slice(0, 20) + '...');

        try {
            const response = await fetchWithAuth('/api/v1/mentor/group');
            const groups = await response.json();
            console.debug('Groups fetched successfully:', groups);
            displayGroups(groups);
        } catch (error) {
            console.error('Error fetching groups:', error.message);
            alert(`An error occurred while fetching your groups: ${error.message}`);
        }
    }

    function displayGroups(groups) {
        const container = document.getElementById('groups-container');
        container.innerHTML = '';

        if (!groups || !groups.length) {
            container.innerHTML = '<p class="text-gray-600">No groups assigned to you.</p>';
            return;
        }

        groups.forEach(group => {
            const groupCard = document.createElement('div');
            groupCard.className = 'bg-white p-6 rounded-lg shadow-md card-hover cursor-pointer';
            groupCard.innerHTML = `<h3 class="text-xl font-semibold text-gray-800">${group.name}</h3>`;
            groupCard.addEventListener('click', () => showGroupDetails(group.id));
            container.appendChild(groupCard);
        });
    }

    async function showGroupDetails(groupId) {
        try {
            const response = await fetchWithAuth(`/api/v1/group/${groupId}`);
            currentGroup = await response.json();
            console.debug('Group details fetched:', currentGroup);
            displayGroupDetails(currentGroup);
        } catch (error) {
            console.error('Error fetching group details:', error);
            alert(`An error occurred while fetching group details: ${error.message}`);
        }
    }

    function displayGroupDetails(group) {
        document.getElementById('groups-container').classList.add('hidden');
        document.getElementById('group-details').classList.remove('hidden');
        document.getElementById('module-details').classList.add('hidden');
        document.getElementById('task-details').classList.add('hidden');

        document.getElementById('group-name').textContent = group.name;

        const studentsList = document.getElementById('students-list');
        studentsList.innerHTML = '';
        if (group.students && group.students.length > 0) {
            group.students.forEach(student => {
                const studentDiv = document.createElement('div');
                studentDiv.className = 'flex items-center bg-white p-4 rounded shadow mb-2';
                const imageSrc = getImageSrc(student.image);
                studentDiv.innerHTML = `
                    <img src="${imageSrc}" alt="${student.firstName} ${student.lastName}" class="w-12 h-12 rounded-full mr-4">
                    <div>
                        <p class="font-semibold text-lg">${student.firstName} ${student.lastName}</p>
                        <p class="text-gray-600">${student.phoneNumber}</p>
                    </div>
                `;
                studentsList.appendChild(studentDiv);
            });
        } else {
            studentsList.textContent = 'No students in this group.';
        }

        const modulesList = document.getElementById('modules-list');
        const modulesWarning = document.getElementById('modules-warning');
        modulesList.innerHTML = '';
        if (group.modules && group.modules.length > 0) {
            modulesWarning.classList.add('hidden');
            group.modules.forEach(module => {
                const button = document.createElement('button');
                button.className = module.active
                    ? 'bg-green-500 text-white p-2 rounded hover:bg-green-600 m-1'
                    : 'bg-gray-400 text-white p-2 rounded m-1 cursor-not-allowed';
                button.textContent = module.active ? module.moduleName : `${module.moduleName} 🔒`;
                button.disabled = !module.active;
                if (module.active) {
                    button.addEventListener('click', () => showModuleDetails(module.id));
                }
                modulesList.appendChild(button);
            });
        } else {
            modulesWarning.textContent = 'Warning: No modules assigned to this group.';
            modulesWarning.classList.remove('hidden');
        }
    }

    async function showModuleDetails(moduleId) {
        try {
            const response = await fetchWithAuth(`/api/v1/module/${moduleId}`);
            const moduleData = await response.json();
            console.debug('Raw module API response:', moduleData);
            if (!moduleData.id || typeof moduleData.id !== 'number' || isNaN(moduleData.id) || moduleData.id <= 0 || !Number.isInteger(moduleData.id)) {
                console.error('Invalid module id in response:', moduleData);
                alert('Invalid module data received. Please try again.');
                return;
            }
            currentModule = moduleData;
            console.debug('Set currentModule with id:', currentModule.id);
            displayModuleDetails(currentModule);
        } catch (error) {
            console.error('Error fetching module details:', error);
            alert(`An error occurred while fetching module details: ${error.message}`);
        }
    }

    function displayModuleDetails(module) {
        document.getElementById('group-details').classList.add('hidden');
        document.getElementById('module-details').classList.remove('hidden');
        document.getElementById('task-details').classList.add('hidden');

        document.getElementById('module-name').textContent = module.moduleName;

        console.debug('Module active status:', {
            moduleId: module.id,
            moduleName: module.moduleName,
            active: module.active
        });

        const closeModuleButton = document.getElementById('close-module-button');
        if (module.active || module.active === undefined) {
            closeModuleButton.classList.add('visible');
            console.debug('Showing Close Module button for module:', module.id);
        } else {
            closeModuleButton.classList.remove('visible');
            console.debug('Hiding Close Module button for module:', module.id);
        }

        const tasksList = document.getElementById('tasks-list');
        tasksList.innerHTML = '';
        if (module.tasks && module.tasks.length > 0) {
            module.tasks.forEach(task => {
                const taskButton = document.createElement('button');
                taskButton.className = 'bg-blue-500 text-white p-2 rounded m-1 hover:bg-blue-600';
                taskButton.textContent = task.taskName;
                taskButton.addEventListener('click', () => showTaskDetails(task.id));
                tasksList.appendChild(taskButton);
            });
        } else {
            tasksList.textContent = 'No tasks in this module.';
        }
    }

    async function showTaskDetails(taskId) {
        try {
            const taskResponse = await fetchWithAuth(`/api/v1/task/${taskId}`);
            const task = await taskResponse.json();
            currentTaskId = taskId;
            currentTask = task;

            const taskAttachmentIds = task.attachmentId?.filter(id => id != null) || [];
            const questionAttachmentIds = task.questionRes?.map(q => q.attachmentId).filter(id => id != null) || [];
            const attachmentIds = [...new Set([...taskAttachmentIds, ...questionAttachmentIds])];
            console.debug('Fetching attachments for IDs:', attachmentIds);

            const attachments = await fetchAttachments(attachmentIds);
            const attachmentMap = new Map(attachments.map(a => [a.id, a]));

            displayTaskDetails(task, attachmentMap);
        } catch (error) {
            console.error('Error fetching task details or attachments:', error);
            alert(`An error occurred while fetching task details: ${error.message}`);
        }
    }

    async function fetchAttachments(attachmentIds) {
        const promises = attachmentIds.map(id =>
            fetchWithAuth(`/api/v1/attachments/${id}`).then(response => {
                if (!response.ok) return null;
                return response.json();
            }).catch(error => {
                console.error(`Error fetching attachment ${id}:`, error);
                return null;
            })
        );
        const results = await Promise.all(promises);
        return results.filter(a => a != null);
    }

    function displayTaskDetails(task, attachmentMap) {
        document.getElementById('module-details').classList.add('hidden');
        document.getElementById('task-details').classList.remove('hidden');

        document.getElementById('task-name').textContent = task.name || task.taskName;

        const videoDiv = document.getElementById('task-video');
        videoDiv.innerHTML = '';
        if (task.youtubeURL) {
            try {
                const url = new URL(task.youtubeURL);
                const videoId = url.searchParams.get('v') || url.pathname.split('/').pop();
                if (videoId) {
                    const embedUrl = `https://www.youtube.com/embed/${videoId}`;
                    videoDiv.innerHTML = `
                        <iframe width="560" height="315" src="${embedUrl}" title="YouTube video player"
                            frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen class="max-w-full" onerror="this.style.display='none'; document.getElementById('youtube-fallback').style.display='block';"></iframe>
                        <p id="youtube-fallback" class="text-red-600" style="display:none;">Unable to load YouTube video. URL: <a href="${task.youtubeURL}" class="underline">${task.youtubeURL}</a></p>
                    `;
                } else {
                    videoDiv.innerHTML = `<p class="text-red-600">Invalid YouTube URL: <a href="${task.youtubeURL}" class="underline">${task.youtubeURL}</a></p>`;
                }
            } catch {
                videoDiv.innerHTML = `<p class="text-red-600">Invalid YouTube URL: <a href="${task.youtubeURL}" class="underline">${task.youtubeURL}</a></p>`;
            }
        }

        const attachmentsList = document.getElementById('attachments-list');
        attachmentsList.innerHTML = '';
        if (task.attachmentId && task.attachmentId.length > 0) {
            task.attachmentId.forEach(id => {
                const attachment = attachmentMap.get(id);
                const attachmentDiv = document.createElement('div');
                attachmentDiv.className = 'mb-2';
                if (attachment) {
                    if (attachment.contentType?.startsWith('image/')) {
                        const imageSrc = `data:${attachment.contentType};base64,${attachment.content}`;
                        attachmentDiv.innerHTML = `<img src="${imageSrc}" alt="Attachment ${id}" class="max-w-full h-auto">`;
                    } else {
                        const dataUrl = `data:${attachment.contentType || 'application/octet-stream'};base64,${attachment.content}`;
                        attachmentDiv.innerHTML = `<a href="${dataUrl}" download class="text-blue-500 underline">Download Attachment ${id}</a>`;
                    }
                } else {
                    attachmentDiv.innerHTML = `<p class="text-red-600">Attachment not found. URL: ${BASE_URL}/api/v1/attachments/${id}</p>`;
                }
                attachmentsList.appendChild(attachmentDiv);
            });
        } else {
            attachmentsList.textContent = 'No attachments for this task.';
        }

        const questionsList = document.getElementById('questions-list');
        questionsList.innerHTML = '';
        if (task.questionRes && task.questionRes.length > 0) {
            task.questionRes.forEach(question => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'mb-4 p-4 bg-white rounded shadow';
                let html = `
                    <h4 class="text-lg font-semibold">${question.questionTest}</h4>
                    <ul class="list-disc list-inside">
                        ${question.variant.map(v => `<li>${v}</li>`).join('')}
                    </ul>
                    <p class="mt-2"><strong>Correct Answer:</strong> ${question.currentAnswer || 'N/A'}</p>
                `;
                if (question.attachmentId) {
                    console.debug('Processing question attachment:', { questionId: question.id, attachmentId: question.attachmentId });
                    const attachment = attachmentMap.get(Number(question.attachmentId));
                    if (attachment) {
                        if (attachment.contentType?.startsWith('image/')) {
                            const imageSrc = `data:${attachment.contentType};base64,${attachment.content}`;
                            html += `<img src="${imageSrc}" alt="Question Attachment ${question.attachmentId}" class="mt-2 max-w-full h-auto">`;
                        } else {
                            const dataUrl = `data:${attachment.contentType || 'application/octet-stream'};base64,${attachment.content}`;
                            html += `<a href="${dataUrl}" download class="text-blue-500 underline mt-2 block">Download Question Attachment ${question.attachmentId}</a>`;
                        }
                    } else {
                        html += `<p class="mt-2 text-red-600">Question attachment not found. URL: ${BASE_URL}/api/v1/attachments/${question.attachmentId}</p>`;
                    }
                } else {
                    console.debug('No attachment for question:', { questionId: question.id });
                }
                questionDiv.innerHTML = html;
                questionsList.appendChild(questionDiv);
            });
        } else {
            questionsList.textContent = 'No questions in this task.';
        }
    }

    async function addTask() {
        const taskName = document.getElementById('task-name').value;
        const youtubeURL = document.getElementById('youtube-url').value;
        const attachmentsInput = document.getElementById('attachments');
        const attachments = attachmentsInput.files;

        if (!taskName) {
            alert('Task name is required.');
            return;
        }

        if (!currentModule || currentModule.id == null || typeof currentModule.id !== 'number' || isNaN(currentModule.id) || currentModule.id <= 0 || !Number.isInteger(currentModule.id)) {
            console.error('Invalid or no module selected:', currentModule);
            alert('Please select a valid module before adding a task.');
            return;
        }

        const moduleId = currentModule.id;
        console.debug('Sending moduleId:', moduleId);

        const formData = new FormData();
        formData.append('taskName', taskName);
        formData.append('youtubeURL', youtubeURL || '');
        formData.append('moduleId', String(moduleId));
        for (let i = 0; i < attachments.length; i++) {
            formData.append('attachments', attachments[i]);
        }

        console.debug('FormData contents:', Object.fromEntries(formData));

        try {
            const response = await fetchWithAuth('/api/v1/task', {
                method: 'POST',
                headers: {},
                body: formData
            });

            const data = await response.json();
            console.debug('Task added successfully:', data);
            alert('Task added successfully!');
            await showModuleDetails(moduleId);
            document.getElementById('add-task-form').classList.add('hidden');
            document.getElementById('task-name').value = '';
            document.getElementById('youtube-url').value = '';
            document.getElementById('attachments').value = '';
        } catch (error) {
            console.error('Error adding task:', error.message);
            alert(`An error occurred while adding the task: ${error.message}`);
        }
    }

    async function updateTask() {
        const taskName = document.getElementById('update-task-name').value;
        const youtubeURL = document.getElementById('update-youtube-url').value;
        const attachmentsInput = document.getElementById('update-attachments');
        const attachments = attachmentsInput.files;

        if (!taskName) {
            alert('Task name is required.');
            return;
        }

        if (!currentTaskId || !currentModule || currentModule.id == null) {
            console.error('Invalid task or module:', { currentTaskId, currentModule });
            alert('Please select a valid task and module before updating.');
            return;
        }

        const formData = new FormData();
        formData.append('taskName', taskName);
        formData.append('youtubeURL', youtubeURL || '');
        formData.append('moduleId', String(currentModule.id));
        for (let i = 0; i < attachments.length; i++) {
            formData.append('attachments', attachments[i]);
        }

        console.debug('FormData contents for update:', Object.fromEntries(formData));

        try {
            const response = await fetchWithAuth(`/api/v1/task/${currentTaskId}`, {
                method: 'POST',
                headers: {},
                body: formData
            });

            const data = await response.json();
            console.debug('Task updated successfully:', data);
            alert('Task updated successfully!');
            const moduleId = currentModule.id;
            await showModuleDetails(moduleId);
            document.getElementById('task-details').classList.add('hidden');
            document.getElementById('update-task-form').classList.add('hidden');
            document.getElementById('update-task-name').value = '';
            document.getElementById('update-youtube-url').value = '';
            document.getElementById('update-attachments').value = '';
        } catch (error) {
            console.error('Error updating task:', error.message);
            alert(`An error occurred while updating the task: ${error.message}`);
        }
    }

    async function closeModule() {
        if (!currentModule || !currentModule.id) {
            console.error('No module selected for closing:', currentModule);
            alert('Please select a valid module to close.');
            return;
        }

        if (!confirm('Are you sure you want to close this module? It will no longer be accessible.')) {
            return;
        }

        try {
            const response = await fetchWithAuth(`/api/v1/module/${currentModule.id}`, {
                method: 'DELETE',
                headers: {}
            });

            console.debug('Module closed successfully:', { moduleId: currentModule.id, status: response.status });
            alert('Module closed successfully!');

            const groupId = currentGroup?.id;
            currentModule = null;

            if (groupId) {
                await showGroupDetails(groupId);
            } else {
                console.warn('No current group set, refreshing groups.');
                await fetchMentorGroups();
            }
        } catch (error) {
            console.error('Error closing module:', {
                moduleId: currentModule?.id,
                error: error.message,
                stack: error.stack
            });
            alert(`An error occurred while closing the module: ${error.message}`);
        }
    }

    async function addQuestion() {
        const questionTest = document.getElementById('question-test').value;
        const attachmentInput = document.getElementById('question-attachment');
        const attachment = attachmentInput.files[0];
        const variantsContainer = document.getElementById('variants-container');
        const variantInputs = variantsContainer.querySelectorAll('input[type="text"]');
        const correctCheckboxes = variantsContainer.querySelectorAll('input[type="checkbox"]');

        if (!questionTest) {
            alert('Question text is required.');
            return;
        }

        const variants = Array.from(variantInputs)
            .map(input => input.value.trim())
            .filter(value => value);
        if (variants.length === 0) {
            alert('At least one variant is required.');
            return;
        }

        const correctAnswers = Array.from(correctCheckboxes)
            .map((checkbox, index) => checkbox.checked ? variants[index] : null)
            .filter(answer => answer);
        if (correctAnswers.length === 0) {
            alert('At least one correct answer must be selected.');
            return;
        }

        let attachmentId = null;
        if (attachment) {
            try {
                const attachmentData = await createAttachment(attachment);
                attachmentId = attachmentData.id;
                if (!attachmentId) {
                    throw new Error('No attachment ID received from server');
                }
                console.debug('Question attachment uploaded:', { attachmentId });
            } catch (error) {
                console.error('Attachment error details:', error);
                alert(`Failed to upload attachment: ${error.message}. Please try again.`);
                return;
            }
        }

        const questionData = {
            questionTest,
            attachmentId,
            variant: variants,
            currentAnswer: correctAnswers.join(','),
            taskId: currentTaskId
        };

        console.debug('Submitting question:', questionData);

        try {
            const response = await fetchWithAuth('/api/v1/questions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(questionData)
            });

            const questionRes = await response.json();
            console.debug('Question added successfully:', questionRes);
            await showTaskDetails(currentTaskId);
            document.getElementById('add-question-form').classList.add('hidden');
            document.getElementById('question-test').value = '';
            document.getElementById('question-attachment').value = '';
            variantsContainer.innerHTML = '';
            addVariantInput(variantsContainer, 0);
        } catch (error) {
            console.error('Error adding question:', error);
            alert(`An error occurred while adding the question: ${error.message}`);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (!localStorage.getItem('authToken')) {
            console.warn('No auth token found. Setting default token for testing.');
            localStorage.setItem('authToken', 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMjM0Iiwicm9sZXMiOiJST0xFX01FTlRPUiIsImlhdCI6MTc1MDQwNjc5NywiZXhwIjoxNzUxMDExNTk3fQ.R8CXGXqMrADhJSquC3NQtT2wj_owbcdUf_eaZ4yC74A');
        }

        try {
            displayMentorProfile();
            fetchMentorGroups();
        } catch (error) {
            console.error('Error during page initialization:', error);
            alert('Failed to load dashboard. Please try again.');
        }

        const variantsContainer = document.getElementById('variants-container');
        const addVariantButton = document.getElementById('add-variant-button');

        addVariantInput(variantsContainer, 0);

        addVariantButton.addEventListener('click', () => {
            const currentVariants = variantsContainer.querySelectorAll('input[type="text"]').length;
            addVariantInput(variantsContainer, currentVariants);
        });

        document.getElementById('edit-profile-button').addEventListener('click', () => {
            const userData = JSON.parse(localStorage.getItem('userData'));
            if (userData) {
                document.getElementById('update-first-name').value = userData.firstName || '';
                document.getElementById('update-last-name').value = userData.lastName || '';
                document.getElementById('update-profile-phone').value = userData.phoneNumber || '';
            }
            document.getElementById('edit-profile-form').classList.remove('hidden');
        });

        document.getElementById('cancel-profile-update').addEventListener('click', () => {
            document.getElementById('edit-profile-form').classList.add('hidden');
            document.getElementById('update-first-name').value = '';
            document.getElementById('update-last-name').value = '';
            document.getElementById('update-profile-phone').value = '';
            document.getElementById('update-profile-picture').value = '';
        });

        document.getElementById('submit-profile-update').addEventListener('click', (e) => {
            e.preventDefault();
            updateProfile();
        });

        document.getElementById('back-to-groups').addEventListener('click', () => {
            document.getElementById('group-details').classList.add('hidden');
            document.getElementById('module-details').classList.add('hidden');
            document.getElementById('task-details').classList.add('hidden');
            document.getElementById('groups-container').classList.remove('hidden');
        });

        document.getElementById('back-to-group').addEventListener('click', () => {
            if (currentGroup) showGroupDetails(currentGroup.id);
        });

        document.getElementById('back-to-module').addEventListener('click', () => {
            if (currentModule) showModuleDetails(currentModule.id);
        });

        document.getElementById('add-task-button').addEventListener('click', () => {
            if (!currentModule || currentModule.id == null || typeof currentModule.id !== 'number' || isNaN(currentModule.id) || currentModule.id <= 0 || !Number.isInteger(currentModule.id)) {
                console.error('Cannot open task form. Invalid or no module selected:', currentModule);
                alert('Please select a valid module before adding a task.');
                return;
            }
            console.debug('Opening task form for moduleId:', currentModule.id);
            document.getElementById('add-task-form').classList.remove('hidden');
        });

        document.getElementById('submit-task').addEventListener('click', (e) => {
            e.preventDefault();
            addTask();
        });

        document.getElementById('close-module-button').addEventListener('click', (e) => {
            e.preventDefault();
            closeModule();
        });

        document.getElementById('add-question-button').addEventListener('click', () => {
            document.getElementById('add-question-form').classList.remove('hidden');
            variantsContainer.innerHTML = '';
            addVariantInput(variantsContainer, 0);
        });

        document.getElementById('submit-question').addEventListener('click', (e) => {
            e.preventDefault();
            addQuestion();
        });

        document.getElementById('update-task-button').addEventListener('click', () => {
            if (!currentTask) {
                console.error('No task selected for updating.');
                alert('Please select a task to update.');
                return;
            }
            document.getElementById('update-task-name').value = currentTask.name || currentTask.taskName || '';
            document.getElementById('update-youtube-url').value = currentTask.youtubeURL || '';
            document.getElementById('update-task-form').classList.remove('hidden');
        });

        document.getElementById('submit-update-task').addEventListener('click', (e) => {
            e.preventDefault();
            updateTask();
        });
    });
</script>
</body>
</html>