<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPE School - Supermentor Cabinet</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
        header { background-color: #007bff; color: white; padding: 10px 20px; text-align: center; }
        header h1 { margin: 0; }
        nav a { color: white; margin: 0 15px; text-decoration: none; }
        nav a:hover { text-decoration: underline; }
        main { max-width: 1200px; margin: 20px auto; padding: 20px; }
        section { background: white; padding: 20px; margin-bottom: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .science-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .science-card { background: #e9ecef; padding: 15px; border-radius: 5px; }
        .science-card h3 { margin-top: 0; color: #333; }
        .module { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; }
        .module h4 { color: #007bff; }
        .add-science-form, .update-science-form { display: none; margin-top: 10px; }
        footer { background-color: #333; color: white; text-align: center; padding: 10px 0; position: relative; bottom: 0; width: 100%; }
        form { display: flex; flex-direction: column; gap: 10px; }
        form label { font-weight: bold; }
        form input, form button { padding: 8px; font-size: 16px; }
        form button { background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 3px; }
        form button:hover { background-color: #0056b3; }
        .error { color: red; display: none; }
        .success { color: green; display: none; }
        .note { color: #555; font-style: italic; }
    </style>
</head>
<body>
<header>
    <h1>IPE School</h1>
    <nav>
        <a href="#">Home</a>
        <a href="#">About</a>
        <a href="#">Mentors</a>
        <a href="#" id="logout-link">Logout</a>
    </nav>
</header>
<main>
    <section id="profile">
        <h2>Supermentor Profile</h2>
        <a href="#" id="edit-profile-link">Edit Profile</a>
        <form id="profile-form" style="display: none;">
            <label for="first-name">First Name</label>
            <input type="text" id="first-name" name="first-name">
            <label for="last-name">Last Name</label>
            <input type="text" id="last-name" name="last-name">
            <label for="phone">Phone Number</label>
            <input type="tel" id="phone" name="phone">
            <label for="profile-picture">Profile Picture</label>
            <input type="file" id="profile-picture" name="profile-picture">
            <span id="file-status">No file chosen</span>
            <div>
                <button type="button" id="cancel-profile">Cancel</button>
                <button type="submit">Update Profile</button>
            </div>
            <p id="profile-error" class="error"></p>
            <p id="profile-success" class="success"></p>
        </form>
        <div id="profile-display">
            <p><strong>First Name:</strong> <span id="display-first-name"></span></p>
            <p><strong>Last Name:</strong> <span id="display-last-name"></span></p>
            <p><strong>Phone Number:</strong> <span id="display-phone"></span></p>
            <p><strong>Profile Picture:</strong> <img id="display-profile-picture" alt="No picture" style="max-width: 100px;"></p>
        </div>
    </section>
    <section id="dashboard">
        <h2>Supermentor Dashboard</h2>
        <p>Welcome to your supermentor cabinet. Below are all sciences you oversee.</p>
        <p id="science-count">0 Sciences</p>
    </section>
    <section id="sciences">
        <h2>All Sciences</h2>
        <button onclick="toggleAddScienceForm()">Add Science</button>
        <div id="add-science-form" class="add-science-form">
            <h3>Add New Science</h3>
            <form onsubmit="addScience(event)">
                <label for="science-name">Science Name</label>
                <input type="text" id="science-name" name="science-name" required>
                <label for="group-ids">Group IDs (comma-separated)</label>
                <input type="text" id="group-ids" name="group-ids" placeholder="e.g., 1,2,3">
                <button type="submit">Add Science</button>
                <p id="science-add-error" class="error"></p>
                <p id="science-add-success" class="success"></p>
            </form>
        </div>
        <p class="note">Note: Task, question, and module management is not supported due to missing backend endpoints (e.g., /api/v1/modules/{moduleId}/tasks). Contact your backend team to implement these if needed.</p>
        <div id="science-cards" class="science-cards">
            <!-- Science cards will be populated by JavaScript -->
        </div>
        <p id="sciences-error" class="error"></p>
    </section>
</main>
<footer>
    <section>
        <h2>About Us</h2>
        <p>IPE School is a leading educational institution dedicated to providing quality education with expert mentors and modern facilities.</p>
        <div>
            <a href="#"><img src="facebook-icon.png" alt="Facebook"></a>
            <a href="#"><img src="twitter-icon.png" alt="Twitter"></a>
            <a href="#"><img src="linkedin-icon.png" alt="LinkedIn"></a>
            <a href="#"><img src="instagram-icon.png" alt="Instagram"></a>
        </div>
    </section>
    <section>
        <h2>Quick Links</h2>
        <nav>
            <a href="#">Home</a>
            <a href="#">About</a>
            <a href="#">Mentors</a>
            <a href="#">Login</a>
        </nav>
    </section>
    <section>
        <h2>Contact Info</h2>
        <p>123 Education Street, Tashkent</p>
        reneg<p>+998 90 123 45 67</p>
        <p>info@ipeschool.com</p>
    </section>
    <p>Â© 2023 IPE School. All Rights Reserved.</p>
</footer>
<script>
    async function fetchSciences() {
        try {
            const response = await fetch('/api/v1/sciences', { credentials: 'include' });
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            if (!response.ok) throw new Error(`Failed to fetch sciences: ${response.statusText}`);
            const sciences = await response.json();
            renderSciences(sciences);
            fetchScienceCount();
        } catch (error) {
            document.getElementById('sciences-error').textContent = `Error loading sciences: ${error.message}`;
            document.getElementById('sciences-error').style.display = 'block';
        }
    }

    async function fetchScienceCount() {
        try {
            const response = await fetch('/api/v1/sciences/count', { credentials: 'include' });
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            if (!response.ok) throw new Error(`Failed to fetch science count: ${response.statusText}`);
            const count = await response.json();
            document.getElementById('science-count').textContent = `${count} Sciences`;
        } catch (error) {
            document.getElementById('sciences-error').textContent = `Error loading science count: ${error.message}`;
            document.getElementById('sciences-error').style.display = 'block';
        }
    }

    function renderSciences(sciences) {
        const scienceCards = document.getElementById('science-cards');
        scienceCards.innerHTML = '';
        sciences.forEach(science => {
            const card = document.createElement('div');
            card.className = 'science-card';
            let groupsHtml = science.groups?.length > 0 ? science.groups.map(g => g.name).join(', ') : 'None';
            let modulesHtml = science.modules?.length > 0 ? science.modules.map(m => `<div class="module"><h4>${m.moduleName} (${m.taskCount} tasks)</h4></div>`).join('') : '<p>No modules</p>';
            card.innerHTML = `
                    <h3>${science.name}</h3>
                    <p><strong>Groups:</strong> ${groupsHtml}</p>
                    <p><strong>Modules:</strong></p>
                    ${modulesHtml}
                    <button onclick="toggleUpdateScienceForm(${science.id})">Update Science</button>
                    <button onclick="deleteScience(${science.id})">Delete Science</button>
                    <div id="update-science-form-${science.id}" class="update-science-form">
                        <h3>Update Science</h3>
                        <form onsubmit="updateScience(event, ${science.id})">
                            <label for="update-science-name-${science.id}">Science Name</label>
                            <input type="text" id="update-science-name-${science.id}" name="science-name" value="${science.name}" required>
                            <label for="update-group-ids-${science.id}">Group IDs (comma-separated)</label>
                            <input type="text" id="update-group-ids-${science.id}" name="group-ids" value="${science.groups?.map(g => g.id).join(',') || ''}">
                            <button type="submit">Update Science</button>
                            <p id="science-update-error-${science.id}" class="error"></p>
                            <p id="science-update-success-${science.id}" class="success"></p>
                        </form>
                    </div>
                `;
            scienceCards.appendChild(card);
        });
    }

    function toggleAddScienceForm() {
        document.getElementById('add-science-form').style.display =
            document.getElementById('add-science-form').style.display === 'block' ? 'none' : 'block';
    }

    function toggleUpdateScienceForm(scienceId) {
        document.getElementById(`update-science-form-${scienceId}`).style.display =
            document.getElementById(`update-science-form-${scienceId}`).style.display === 'block' ? 'none' : 'block';
    }

    async function addScience(event) {
        event.preventDefault();
        const name = document.getElementById('science-name').value;
        const groupIds = document.getElementById('group-ids').value.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
        const scienceReq = { name, groupIds };
        try {
            const response = await fetch('/api/v1/sciences', {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(scienceReq)
            });
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            if (!response.ok) throw new Error(`Failed to add science: ${response.statusText}`);
            document.getElementById('science-add-success').textContent = 'Science added successfully!';
            document.getElementById('science-add-success').style.display = 'block';
            document.getElementById('science-add-error').style.display = 'none';
            fetchSciences();
            document.getElementById('add-science-form').style.display = 'none';
            document.getElementById('science-name').value = '';
            document.getElementById('group-ids').value = '';
        } catch (error) {
            document.getElementById('science-add-error').textContent = `Error adding science: ${error.message}`;
            document.getElementById('science-add-error').style.display = 'block';
            document.getElementById('science-add-success').style.display = 'none';
        }
    }

    async function updateScience(event, scienceId) {
        event.preventDefault();
        const name = document.getElementById(`update-science-name-${scienceId}`).value;
        const groupIds = document.getElementById(`update-group-ids-${scienceId}`).value.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
        const scienceReq = { name, groupIds };
        try {
            const response = await fetch(`/api/v1/sciences/${scienceId}`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(scienceReq)
            });
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            if (!response.ok) throw new Error(`Failed to update science: ${response.statusText}`);
            document.getElementById(`science-update-success-${scienceId}`).textContent = 'Science updated successfully!';
            document.getElementById(`science-update-success-${scienceId}`).style.display = 'block';
            document.getElementById(`science-update-error-${scienceId}`).style.display = 'none';
            fetchSciences();
            document.getElementById(`update-science-form-${scienceId}`).style.display = 'none';
        } catch (error) {
            document.getElementById(`science-update-error-${scienceId}`).textContent = `Error updating science: ${error.message}`;
            document.getElementById(`science-update-error-${scienceId}`).style.display = 'block';
            document.getElementById(`science-update-success-${scienceId}`).style.display = 'none';
        }
    }

    async function deleteScience(scienceId) {
        try {
            const response = await fetch(`/api/v1/sciences/${scienceId}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            if (!response.ok) throw new Error(`Failed to delete science: ${response.statusText}`);
            document.getElementById('sciences-error').textContent = 'Science deleted successfully!';
            document.getElementById('sciences-error').style.color = 'green';
            document.getElementById('sciences-error').style.display = 'block';
            setTimeout(() => {
                document.getElementById('sciences-error').style.display = 'none';
                document.getElementById('sciences-error').style.color = 'red';
            }, 3000);
            fetchSciences();
        } catch (error) {
            document.getElementById('sciences-error').textContent = `Error deleting science: ${error.message}`;
            document.getElementById('sciences-error').style.display = 'block';
        }
    }

    async function fetchProfile() {
        try {
            const response = await fetch('/api/v1/users/profile', { credentials: 'include' });
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            if (!response.ok) throw new Error(`Failed to fetch profile: ${response.statusText}`);
            const profile = await response.json();
            document.getElementById('display-first-name').textContent = profile.firstName || 'Not set';
            document.getElementById('display-last-name').textContent = profile.lastName || 'Not set';
            document.getElementById('display-phone').textContent = profile.phone || 'Not set';
            if (profile.profilePictureUrl) document.getElementById('display-profile-picture').src = profile.profilePictureUrl;
        } catch (error) {
            document.getElementById('profile-error').textContent = `Error loading profile: ${error.message}`;
            document.getElementById('profile-error').style.display = 'block';
        }
    }

    document.getElementById('profile-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData();
        formData.append('firstName', document.getElementById('first-name').value);
        formData.append('lastName', document.getElementById('last-name').value);
        formData.append('phone', document.getElementById('phone').value);
        const profilePicture = document.getElementById('profile-picture').files[0];
        if (profilePicture) formData.append('profilePicture', profilePicture);
        try {
            const response = await fetch('/api/v1/users/profile', {
                method: 'POST',
                credentials: 'include',
                body: formData
            });
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            if (!response.ok) throw new Error(`Failed to update profile: ${response.statusText}`);
            document.getElementById('profile-success').textContent = 'Profile updated successfully!';
            document.getElementById('profile-success').style.display = 'block';
            document.getElementById('profile-error').style.display = 'none';
            fetchProfile();
            document.getElementById('profile-form').style.display = 'none';
            document.getElementById('profile-display').style.display = 'block';
        } catch (error) {
            document.getElementById('profile-error').textContent = `Error updating profile: ${error.message}`;
            document.getElementById('profile-error').style.display = 'block';
            document.getElementById('profile-success').style.display = 'none';
        }
    });

    document.getElementById('edit-profile-link').addEventListener('click', (event) => {
        event.preventDefault();
        document.getElementById('profile-form').style.display = 'block';
        document.getElementById('profile-display').style.display = 'none';
    });

    document.getElementById('cancel-profile').addEventListener('click', () => {
        document.getElementById('profile-form').style.display = 'none';
        document.getElementById('profile-display').style.display = 'block';
        document.getElementById('profile-error').style.display = 'none';
        document.getElementById('profile-success').style.display = 'none';
    });

    document.getElementById('logout-link').addEventListener('click', async (event) => {
        event.preventDefault();
        try {
            const response = await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            if (!response.ok) throw new Error(`Failed to logout: ${response.statusText}`);
            window.location.href = '/login';
        } catch (error) {
            document.getElementById('sciences-error').textContent = `Error logging out: ${error.message}`;
            document.getElementById('sciences-error').style.display = 'block';
        }
    });

    document.addEventListener('change', (event) => {
        if (event.target.matches('input[type="file"]')) {
            const statusElement = event.target.nextElementSibling;
            if (statusElement && statusElement.tagName === 'SPAN') {
                statusElement.textContent = event.target.files.length > 0
                    ? Array.from(event.target.files).map(file => file.name).join(', ')
                    : 'No file chosen';
            }
        }
    });

    fetchSciences();
    fetchProfile();
</script>
</body>
</html>