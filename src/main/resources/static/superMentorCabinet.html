<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPE School - Supermentor Cabinet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; }
        .navbar { background-color: #f8f9fa; }
        .navbar-brand, .nav-link { color: #333 !important; }
        .card { margin-bottom: 20px; }
        .section { padding: 50px 0; }
        .footer { background-color: #f8f9fa; padding: 20px 0; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg">
    <div class="container">
        <a class="navbar-brand" href="#">IPE School</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="#about">About</a></li>
                <li class="nav-item"><a class="nav-link" href="#mentors">Mentors</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Logout</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container section">
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Supermentor Profile</h5>
                    <div id="profileInfo">
                        <p><strong>First Name:</strong> <span id="firstName"></span></p>
                        <p><strong>Last Name:</strong> <span id="lastName"></span></p>
                        <p><strong>Phone Number:</strong> <span id="phoneNumber"></span></p>
                        <img id="profilePicture" src="" alt="Profile Picture" class="img-fluid" style="max-width: 100px;">
                    </div>
                    <button class="btn btn-primary mt-3" onclick="showEditProfile()">Edit Profile</button>
                </div>
            </div>

            <div class="card" id="editProfileCard" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title">Edit Profile</h5>
                    <form id="editProfileForm">
                        <div class="mb-3">
                            <label for="editFirstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="editFirstName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editLastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="editLastName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPhoneNumber" class="form-label">Phone Number</label>
                            <input type="text" class="form-control" id="editPhoneNumber" required>
                        </div>
                        <div class="mb-3">
                            <label for="editProfilePicture" class="form-label">Profile Picture</label>
                            <input type="file" class="form-control" id="editProfilePicture">
                            <small class="form-text text-muted">No file chosen</small>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="cancelEditProfile()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Profile</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Supermentor Dashboard</h5>
                    <p>Welcome to your supermentor cabinet. Below are all sciences you oversee.</p>
                    <p><strong>Total Sciences:</strong> <span id="scienceCount">0</span></p>
                </div>
            </div>

            <div id="scienceList">
                <!-- Sciences and modules will be dynamically loaded here -->
            </div>

            <div class="card" id="moduleView" style="display: none;">
                <div class="card-body">
                    <button class="btn btn-link" onclick="backToSciences()">Back to Sciences</button>
                    <h5 id="moduleTitle"></h5>
                    <button class="btn btn-primary" onclick="showAddTaskForm()">Add Task</button>
                    <button class="btn btn-danger" onclick="closeModule()">Close Module</button>
                    <div class="card mt-3" id="addTaskCard" style="display: none;">
                        <div class="card-body">
                            <h6>Add New Task</h6>
                            <form id="addTaskForm">
                                <div class="mb-3">
                                    <label for="taskName" class="form-label">Task Name</label>
                                    <input type="text" class="form-control" id="taskName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="youtubeUrl" class="form-label">YouTube URL</label>
                                    <input type="url" class="form-control" id="youtubeUrl">
                                </div>
                                <div class="mb-3">
                                    <label for="taskAttachments" class="form-label">Attachments</label>
                                    <input type="file" class="form-control" id="taskAttachments" multiple>
                                    <small class="form-text text-muted">No files chosen</small>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Task</button>
                            </form>
                        </div>
                    </div>
                    <div class="card mt-3">
                        <div class="card-body">
                            <h6>Tasks</h6>
                            <div id="taskList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" id="taskView" style="display: none;">
                <div class="card-body">
                    <button class="btn btn-link" onclick="backToModule()">Back to Module</button>
                    <h5 id="taskTitle"></h5>
                    <button class="btn btn-primary" onclick="showUpdateTaskForm()">Update Task</button>
                    <div class="card mt-3" id="updateTaskCard" style="display: none;">
                        <div class="card-body">
                            <h6>Update Task</h6>
                            <form id="updateTaskForm">
                                <div class="mb-3">
                                    <label for="updateTaskName" class="form-label">Task Name</label>
                                    <input type="text" class="form-control" id="updateTaskName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="updateYoutubeUrl" class="form-label">YouTube URL</label>
                                    <input type="url" class="form-control" id="updateYoutubeUrl">
                                </div>
                                <div class="mb-3">
                                    <label for="updateTaskAttachments" class="form-label">Attachments</label>
                                    <input type="file" class="form-control" id="updateTaskAttachments" multiple>
                                    <small class="form-text text-muted">No files chosen</small>
                                </div>
                                <button type="submit" class="btn btn-primary">Update Task</button>
                            </form>
                        </div>
                    </div>
                    <div class="card mt-3">
                        <div class="card-body">
                            <h6>Attachments</h6>
                            <div id="taskAttachmentsList"></div>
                        </div>
                    </div>
                    <div class="card mt-3">
                        <div class="card-body">
                            <h6>Questions</h6>
                            <button class="btn btn-primary" onclick="showAddQuestionForm()">Add</button>
                            <div id="questionList"></div>
                            <div class="card mt-3" id="addQuestionCard" style="display: none;">
                                <div class="card-body">
                                    <h6>New Question</h6>
                                    <form id="addQuestionForm">
                                        <div class="mb-3">
                                            <label for="questionText" class="form-label">Question Text</label>
                                            <textarea class="form-control" id="questionText" required></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="questionAttachment" class="form-label">Attachment (Optional)</label>
                                            <input type="file" class="form-control" id="questionAttachment">
                                            <small class="form-text text-muted">No file chosen</small>
                                        </div>
                                        <div class="mb-3" id="answerVariants">
                                            <h6>Answer Variants</h6>
                                            <div id="variantList"></div>
                                            <button type="button" class="btn btn-secondary" onclick="addAnswerVariant()">Add Variant</button>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Save</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="footer text-center">
    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <h5>About Us</h5>
                <p>IPE School is a leading educational institution dedicated to providing quality education with expert mentors and modern facilities.</p>
                <div class="d-flex justify-content-center">
                    <a href="#" class="mx-2"><i class="fab fa-facebook"></i></a>
                    <a href="#" class="mx-2"><i class="fab fa-twitter"></i></a>
                    <a href="#" class="mx-2"><i class="fab fa-instagram"></i></a>
                    <a href="#" class="mx-2"><i class="fab fa-linkedin"></i></a>
                </div>
            </div>
            <div class="col-md-4">
                <h5>Quick Links</h5>
                <ul class="list-unstyled">
                    <li><a href="/index.html">Home</a></li>
                    <li><a href="#about">About</a></li>
                    <li><a href="#mentors">Mentors</a></li>
                    <li><a href="#login">Login</a></li>
                </ul>
            </div>
            <div class="col-md-4">
                <h5>Contact Info</h5>
                <p>123 Education Street, Tashkent</p>
                <p>+998 90 123 45 67</p>
                <p>info@ipeschool.com</p>
            </div>
        </div>
        <p class="mt-3">© 2023 IPE School. All Rights Reserved.</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_BASE = 'http://localhost:80/api/v1';
    let currentModuleId = null;
    let currentTaskId = null;

    // Fetch and display supermentor profile
    async function loadProfile() {
        try {
            const response = await fetch(`${API_BASE}/profile`, {
                headers: { 'Authorization': `${localStorage.getItem('token')}` }
            });
            const profile = await response.json();
            document.getElementById('firstName').textContent = profile.firstName || 'N/A';
            document.getElementById('lastName').textContent = profile.lastName || 'N/A';
            document.getElementById('phoneNumber').textContent = profile.phoneNumber || 'N/A';
            document.getElementById('profilePicture').src = profile.profilePicture || '';
            document.getElementById('editFirstName').value = profile.firstName || '';
            document.getElementById('editLastName').value = profile.lastName || '';
            document.getElementById('editPhoneNumber').value = profile.phoneNumber || '';
        } catch (error) {
            console.error('Error loading profile:', error);
        }
    }

    // Fetch and display all sciences
    async function loadSciences() {
        try {
            const response = await fetch(`${API_BASE}/science`, {
                headers: { 'Authorization': `${localStorage.getItem('token')}` }
            });
            const sciences = await response.json();
            document.getElementById('scienceCount').textContent = sciences.length;
            const scienceList = document.getElementById('scienceList');
            scienceList.innerHTML = '';
            sciences.forEach(science => {
                const scienceCard = document.createElement('div');
                scienceCard.className = 'card mb-3';
                scienceCard.innerHTML = `
                        <div class="card-body">
                            <h5>${science.name}</h5>
                            <button class="btn btn-primary" onclick="showModules(${science.id}, '${science.name}')">View Modules</button>
                        </div>
                    `;
                scienceList.appendChild(scienceCard);
                science.modules.forEach(module => {
                    const moduleCard = document.createElement('div');
                    moduleCard.className = 'card mb-2 ms-3';
                    moduleCard.innerHTML = `
                            <div class="card-body">
                                <h6>${module.moduleName}</h6>
                                <p>Tasks: ${module.tasks.length}</p>
                                <button class="btn btn-primary" onclick="showModuleDetails(${module.id}, '${module.moduleName}')">View Details</button>
                            </div>
                        `;
                    scienceList.appendChild(moduleCard);
                });
            });
        } catch (error) {
            console.error('Error loading sciences:', error);
        }
    }

    // Show modules for a specific science
    function showModules(scienceId, scienceName) {
        // Handled in loadSciences; modules are already displayed
    }

    // Show module details and tasks
    async function showModuleDetails(moduleId, moduleName) {
        currentModuleId = moduleId;
        document.getElementById('scienceList').style.display = 'none';
        document.getElementById('moduleView').style.display = 'block';
        document.getElementById('moduleTitle').textContent = moduleName;
        await loadTasks(moduleId);
    }

    // Fetch and display tasks for a module
    async function loadTasks(moduleId) {
        try {
            const response = await fetch(`${API_BASE}/module/${moduleId}/tasks`, {
                headers: { 'Authorization': `${localStorage.getItem('token')}` }
            });
            const tasks = await response.json();
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            tasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.className = 'card mb-2';
                taskCard.innerHTML = `
                        <div class="card-body">
                            <h6>${task.taskName}</h6>
                            <button class="btn btn-primary" onclick="showTaskDetails(${task.id}, '${task.taskName}')">View Details</button>
                        </div>
                    `;
                taskList.appendChild(taskCard);
            });
        } catch (error) {
            console.error('Error loading tasks:', error);
        }
    }

    // Show task details and questions
    async function showTaskDetails(taskId, taskName) {
        currentTaskId = taskId;
        document.getElementById('moduleView').style.display = 'none';
        document.getElementById('taskView').style.display = 'block';
        document.getElementById('taskTitle').textContent = taskName;
        await loadTaskAttachments(taskId);
        await loadQuestions(taskId);
    }

    // Fetch and display task attachments
    async function loadTaskAttachments(taskId) {
        try {
            const response = await fetch(`${API_BASE}/task/${taskId}/attachments`, {
                headers: { 'Authorization': `${localStorage.getItem('token')}` }
            });
            const attachments = await response.json();
            const attachmentsList = document.getElementById('taskAttachmentsList');
            attachmentsList.innerHTML = attachments.map(att => `<p><a href="${att.url}">${att.name}</a></p>`).join('');
        } catch (error) {
            console.error('Error loading attachments:', error);
        }
    }

    // Fetch and display questions for a task
    async function loadQuestions(taskId) {
        try {
            const response = await fetch(`${API_BASE}/task/${taskId}/questions`, {
                headers: { 'Authorization': `${localStorage.getItem('token')}` }
            });
            const questions = await response.json();
            const questionList = document.getElementById('questionList');
            questionList.innerHTML = questions.map(q => `
                    <div class="card mb-2">
                        <div class="card-body">
                            <p>${q.text}</p>
                            <button class="btn btn-primary" onclick="showUpdateQuestionForm(${q.id}, '${q.text}')">Edit</button>
                        </div>
                    </div>
                `).join('');
        } catch (error) {
            console.error('Error loading questions:', error);
        }
    }

    // Show edit profile form
    function showEditProfile() {
        document.getElementById('profileInfo').style.display = 'none';
        document.getElementById('editProfileCard').style.display = 'block';
    }

    // Cancel edit profile
    function cancelEditProfile() {
        document.getElementById('profileInfo').style.display = 'block';
        document.getElementById('editProfileCard').style.display = 'none';
    }

    // Update profile
    document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('firstName', document.getElementById('editFirstName').value);
        formData.append('lastName', document.getElementById('editLastName').value);
        formData.append('phoneNumber', document.getElementById('editPhoneNumber').value);
        const file = document.getElementById('editProfilePicture').files[0];
        if (file) formData.append('profilePicture', file);
        try {
            await fetch(`${API_BASE}/profile`, {
                method: 'PUT',
                headers: { 'Authorization': `${localStorage.getItem('token')}` },
                body: formData
            });
            cancelEditProfile();
            loadProfile();
        } catch (error) {
            console.error('Error updating profile:', error);
        }
    });

    // Show add task form
    function showAddTaskForm() {
        document.getElementById('addTaskCard').style.display = 'block';
    }

    // Add task
    document.getElementById('addTaskForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('taskName', document.getElementById('taskName').value);
        formData.append('youtubeUrl', document.getElementById('youtubeUrl').value);
        const files = document.getElementById('taskAttachments').files;
        for (let file of files) formData.append('attachments', file);
        try {
            await fetch(`${API_BASE}/module/${currentModuleId}/tasks`, {
                method: 'POST',
                headers: { 'Authorization': `${localStorage.getItem('token')}` },
                body: formData
            });
            document.getElementById('addTaskCard').style.display = 'none';
            loadTasks(currentModuleId);
        } catch (error) {
            console.error('Error adding task:', error);
        }
    });

    // Show update task form
    function showUpdateTaskForm() {
        document.getElementById('updateTaskCard').style.display = 'block';
    }

    // Update task
    document.getElementById('updateTaskForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('taskName', document.getElementById('updateTaskName').value);
        formData.append('youtubeUrl', document.getElementById('updateYoutubeUrl').value);
        const files = document.getElementById('updateTaskAttachments').files;
        for (let file of files) formData.append('attachments', file);
        try {
            await fetch(`${API_BASE}/task/${currentTaskId}`, {
                method: 'PUT',
                headers: { 'Authorization': `${localStorage.getItem('token')}` },
                body: formData
            });
            document.getElementById('updateTaskCard').style.display = 'none';
            showTaskDetails(currentTaskId, document.getElementById('updateTaskName').value);
        } catch (error) {
            console.error('Error updating task:', error);
        }
    });

    // Show add question form
    function showAddQuestionForm() {
        document.getElementById('addQuestionCard').style.display = 'block';
    }

    // Add answer variant
    function addAnswerVariant() {
        const variantList = document.getElementById('variantList');
        const variantDiv = document.createElement('div');
        variantDiv.className = 'mb-2';
        variantDiv.innerHTML = `<input type="text" class="form-control" placeholder="Answer variant">`;
        variantList.appendChild(variantDiv);
    }

    // Add question
    document.getElementById('addQuestionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('text', document.getElementById('questionText').value);
        const file = document.getElementById('questionAttachment').files[0];
        अगर file) formData.append('attachment', file);
        const variants = Array.from(document.getElementById('variantList').getElementsByTagName('input'))
            .map(input => input.value).filter(val => val);
        formData.append('answerVariants', JSON.stringify(variants));
        try {
            await fetch(`${API_BASE}/task/${currentTaskId}/questions`, {
                method: 'POST',
                headers: { 'Authorization': `${localStorage.getItem('token')}` },
                body: formData
            });
            document.getElementById('addQuestionCard').style.display = 'none';
            loadQuestions(currentTaskId);
        } catch (error) {
            console.error('Error adding question:', error);
        }
    });

    // Show update question form (placeholder, as not fully implemented in mentorCabinet.html)
    function showUpdateQuestionForm(questionId, questionText) {
        // Implement update question form if needed
        alert('Update question functionality to be implemented');
    }

    // Close module
    async function closeModule() {
        try {
            await fetch(`${API_BASE}/module/${currentModuleId}/close`, {
                method: 'POST',
                headers: { 'Authorization': `${localStorage.getItem('token')}` }
            });
            backToSciences();
        } catch (error) {
            console.error('Error closing module:', error);
        }
    }

    // Navigation functions
    function backToSciences() {
        document.getElementById('moduleView').style.display = 'none';
        document.getElementById('taskView').style.display = 'none';
        document.getElementById('scienceList').style.display = 'block';
        loadSciences();
    }

    function backToModule() {
        document.getElementById('taskView').style.display = 'none';
        document.getElementById('moduleView').style.display = 'block';
        loadTasks(currentModuleId);
    }

    // Logout
    function logout() {
        localStorage.removeItem('token');
        window.location.href = '/index.html';
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
        if (!localStorage.getItem('token')) window.location.href = '/index.html';
        loadProfile();
        loadSciences();
    });
</script>
</body>
</html>