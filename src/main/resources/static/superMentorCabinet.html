<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Management System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .profile-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #667eea;
            cursor: pointer;
        }

        .profile-info {
            display: flex;
            flex-direction: column;
        }

        .profile-name {
            font-weight: bold;
            color: #333;
        }

        .profile-phone {
            font-size: 12px;
            color: #666;
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 10px;
            min-width: 200px;
            display: none;
            z-index: 1000;
        }

        .profile-dropdown.show {
            display: block;
        }

        .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .sciences-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .science-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            padding: 25px;
            color: white;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .science-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }

        .science-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .science-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .module-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .btn-primary {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            border-color: #5a6fd8;
        }

        .btn-success {
            background: #28a745;
            border-color: #28a745;
        }

        .btn-success:hover {
            background: #218838;
            border-color: #218838;
        }

        .btn-danger {
            background: #dc3545;
            border-color: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
            border-color: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            border-color: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
            border-color: #e0a800;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modules-list {
            margin-top: 20px;
        }

        .module-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #28a745;
            transition: transform 0.3s;
        }

        .module-item.inactive {
            border-left-color: #dc3545;
            opacity: 0.8;
        }

        .module-item:hover {
            transform: translateX(5px);
        }

        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .module-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .module-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .task-count {
            background: #e9ecef;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            color: #666;
        }

        .tasks-list {
            margin-top: 15px;
        }

        .task-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .task-name {
            font-weight: 600;
            color: #333;
        }

        .questions-list {
            margin-top: 15px;
        }

        .question-item {
            background: #fff3cd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #ffc107;
        }

        .question-text {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .variants-list {
            margin-left: 20px;
        }

        .variant-item {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .variant-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
        }

        .file-upload.dragover {
            border-color: #667eea;
            background-color: rgba(102, 126, 234, 0.1);
        }

        .attachment-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .attachment-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .attachment-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
        }

        .attachment-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .breadcrumb {
            background: rgba(102, 126, 234, 0.1);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .breadcrumb-item:hover {
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: #999;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .sciences-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 20px;
            }

            .module-header,
            .task-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .module-actions {
                width: 100%;
                justify-content: flex-start;
            }
        }

        @media (max-width: 480px) {
            .btn {
                padding: 8px 15px;
                font-size: 12px;
            }

            .modal-content {
                margin: 5% auto;
                padding: 15px;
            }

            .science-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <i class="fas fa-graduation-cap"></i>
            School Management System
        </div>
        <div class="user-profile" id="userProfile">
            <img src="/placeholder.svg?height=50&width=50" alt="Profile" class="profile-avatar" id="profileAvatar">
            <div class="profile-info">
                <div class="profile-name" id="profileName">Loading...</div>
                <div class="profile-phone" id="profilePhone">Loading...</div>
            </div>
            <div class="profile-dropdown" id="profileDropdown">
                <div class="dropdown-item" onclick="openUpdateProfile()">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </div>
                <div class="dropdown-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="breadcrumb" id="breadcrumb">
            <a href="#" class="breadcrumb-item" onclick="showSciences()">
                <i class="fas fa-home"></i> Sciences
            </a>
        </div>

        <!-- Sciences View -->
        <div id="sciencesView">
            <h2>Available Sciences</h2>
            <div class="sciences-grid" id="sciencesGrid">
                <!-- Sciences will be loaded here -->
            </div>
        </div>

        <!-- Modules View -->
        <div id="modulesView" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                <h2 id="scienceTitle">Modules</h2>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <span class="module-count" id="moduleCount">0 modules</span>
                    <button class="btn btn-primary" onclick="openAddModule()">
                        <i class="fas fa-plus"></i> Add Module
                    </button>
                </div>
            </div>
            <div class="modules-list" id="modulesList">
                <!-- Modules will be loaded here -->
            </div>
        </div>

        <!-- Tasks View -->
        <div id="tasksView" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                <h2 id="moduleTitle">Tasks</h2>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <span class="task-count" id="taskCount">0 tasks</span>
                    <button class="btn btn-primary" onclick="openAddTask()">
                        <i class="fas fa-plus"></i> Add Task
                    </button>
                    <button class="btn btn-warning" onclick="openUpdateModule()">
                        <i class="fas fa-edit"></i> Update Module
                    </button>
                    <button class="btn" id="moduleStatusBtn" onclick="toggleModuleStatus()">
                        <i class="fas fa-eye"></i> Present to Mentors
                    </button>
                </div>
            </div>
            <div class="tasks-list" id="tasksList">
                <!-- Tasks will be loaded here -->
            </div>
        </div>

        <!-- Questions View -->
        <div id="questionsView" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                <h2 id="taskTitle">Questions</h2>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <span class="task-count" id="questionCount">0 questions</span>
                    <button class="btn btn-primary" onclick="openAddQuestion()">
                        <i class="fas fa-plus"></i> Add Question
                    </button>
                    <button class="btn btn-warning" onclick="openUpdateTask()">
                        <i class="fas fa-edit"></i> Update Task
                    </button>
                </div>
            </div>
            <div id="taskDetails" style="margin-bottom: 20px;">
                <!-- Task details will be loaded here -->
            </div>
            <div class="questions-list" id="questionsList">
                <!-- Questions will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Update Profile Modal -->
<div id="updateProfileModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Update Profile</h3>
            <span class="close" onclick="closeModal('updateProfileModal')">&times;</span>
        </div>
        <form id="updateProfileForm">
            <div class="form-group">
                <label class="form-label">Profile Image</label>
                <div class="file-upload" onclick="document.getElementById('profileImageInput').click()">
                    <i class="fas fa-camera"></i>
                    <p>Click to select profile image</p>
                    <input type="file" id="profileImageInput" accept="image/*" style="display: none;" onchange="previewProfileImage(this)">
                </div>
                <div id="profileImagePreview" class="attachment-preview"></div>
            </div>
            <div class="form-group">
                <label class="form-label">First Name</label>
                <input type="text" class="form-control" id="updateFirstName" required>
            </div>
            <div class="form-group">
                <label class="form-label">Last Name</label>
                <input type="text" class="form-control" id="updateLastName" required>
            </div>
            <div class="form-group">
                <label class="form-label">Phone Number</label>
                <input type="tel" class="form-control" id="updatePhoneNumber" required>
            </div>
            <div class="form-group">
                <label class="form-label">Password (Optional)</label>
                <input type="password" class="form-control" id="updatePassword" placeholder="Leave empty to keep current password">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn" onclick="closeModal('updateProfileModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <span id="updateProfileLoading" class="loading" style="display: none;"></span>
                    Update Profile
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Module Modal -->
<div id="addModuleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Add New Module</h3>
            <span class="close" onclick="closeModal('addModuleModal')">&times;</span>
        </div>
        <form id="addModuleForm">
            <div class="form-group">
                <label class="form-label">Module Name</label>
                <input type="text" class="form-control" id="moduleName" required>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn" onclick="closeModal('addModuleModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <span id="addModuleLoading" class="loading" style="display: none;"></span>
                    Add Module
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Task Modal -->
<div id="addTaskModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Add New Task</h3>
            <span class="close" onclick="closeModal('addTaskModal')">&times;</span>
        </div>
        <form id="addTaskForm">
            <div class="form-group">
                <label class="form-label">Task Name</label>
                <input type="text" class="form-control" id="taskName" required>
            </div>
            <div class="form-group">
                <label class="form-label">YouTube URL (Optional)</label>
                <input type="url" class="form-control" id="youtubeURL" placeholder="https://youtube.com/watch?v=...">
            </div>
            <div class="form-group">
                <label class="form-label">Attachments (Optional)</label>
                <div class="file-upload" onclick="document.getElementById('taskAttachments').click()">
                    <i class="fas fa-paperclip"></i>
                    <p>Click to select attachments</p>
                    <input type="file" id="taskAttachments" multiple accept="image/*" style="display: none;" onchange="previewTaskAttachments(this)">
                </div>
                <div id="taskAttachmentsPreview" class="attachment-preview"></div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn" onclick="closeModal('addTaskModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <span id="addTaskLoading" class="loading" style="display: none;"></span>
                    Add Task
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Update Task Modal -->
<div id="updateTaskModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Update Task</h3>
            <span class="close" onclick="closeModal('updateTaskModal')">&times;</span>
        </div>
        <form id="updateTaskForm">
            <div class="form-group">
                <label class="form-label">Task Name</label>
                <input type="text" class="form-control" id="updateTaskName" required>
            </div>
            <div class="form-group">
                <label class="form-label">YouTube URL (Optional)</label>
                <input type="url" class="form-control" id="updateYoutubeURL" placeholder="https://youtube.com/watch?v=...">
            </div>
            <div class="form-group">
                <label class="form-label">Current Attachments</label>
                <div id="currentAttachments" class="attachment-preview"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Add New Attachments (Optional)</label>
                <div class="file-upload" onclick="document.getElementById('updateTaskAttachments').click()">
                    <i class="fas fa-paperclip"></i>
                    <p>Click to select new attachments</p>
                    <input type="file" id="updateTaskAttachments" multiple accept="image/*" style="display: none;" onchange="previewUpdateTaskAttachments(this)">
                </div>
                <div id="updateTaskAttachmentsPreview" class="attachment-preview"></div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn" onclick="closeModal('updateTaskModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <span id="updateTaskLoading" class="loading" style="display: none;"></span>
                    Update Task
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Question Modal -->
<div id="addQuestionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Add New Question</h3>
            <span class="close" onclick="closeModal('addQuestionModal')">&times;</span>
        </div>
        <form id="addQuestionForm">
            <div class="form-group">
                <label class="form-label">Question Text</label>
                <textarea class="form-control" id="questionText" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Question Attachment (Optional)</label>
                <div class="file-upload" onclick="document.getElementById('questionAttachment').click()">
                    <i class="fas fa-image"></i>
                    <p>Click to select question image</p>
                    <input type="file" id="questionAttachment" accept="image/*" style="display: none;" onchange="previewQuestionAttachment(this)">
                </div>
                <div id="questionAttachmentPreview" class="attachment-preview"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Answer Variants</label>
                <div id="variantsList">
                    <div class="variant-item">
                        <input type="text" class="variant-input" placeholder="Variant 1" required>
                        <input type="radio" name="correctAnswer" value="0" required>
                        <label>Correct</label>
                        <button type="button" class="btn btn-danger" onclick="removeVariant(this)" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="variant-item">
                        <input type="text" class="variant-input" placeholder="Variant 2" required>
                        <input type="radio" name="correctAnswer" value="1" required>
                        <label>Correct</label>
                        <button type="button" class="btn btn-danger" onclick="removeVariant(this)" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <button type="button" class="btn btn-success" onclick="addVariant()" style="margin-top: 10px;">
                    <i class="fas fa-plus"></i> Add Variant
                </button>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn" onclick="closeModal('addQuestionModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <span id="addQuestionLoading" class="loading" style="display: none;"></span>
                    Add Question
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Update Question Modal -->
<div id="updateQuestionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Update Question</h3>
            <span class="close" onclick="closeModal('updateQuestionModal')">&times;</span>
        </div>
        <form id="updateQuestionForm">
            <div class="form-group">
                <label class="form-label">Question Text</label>
                <textarea class="form-control" id="updateQuestionText" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Current Attachment</label>
                <div id="currentQuestionAttachment" class="attachment-preview"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Update Attachment (Optional)</label>
                <div class="file-upload" onclick="document.getElementById('updateQuestionAttachment').click()">
                    <i class="fas fa-image"></i>
                    <p>Click to select new question image</p>
                    <input type="file" id="updateQuestionAttachment" accept="image/*" style="display: none;" onchange="previewUpdateQuestionAttachment(this)">
                </div>
                <div id="updateQuestionAttachmentPreview" class="attachment-preview"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Answer Variants</label>
                <div id="updateVariantsList">
                    <!-- Variants will be loaded here -->
                </div>
                <button type="button" class="btn btn-success" onclick="addUpdateVariant()" style="margin-top: 10px;">
                    <i class="fas fa-plus"></i> Add Variant
                </button>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn" onclick="closeModal('updateQuestionModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <span id="updateQuestionLoading" class="loading" style="display: none;"></span>
                    Update Question
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Global variables
    let currentScience = null;
    let currentModule = null;
    let currentTask = null;
    let currentQuestion = null;
    let userData = null;

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        loadUserData();
        loadSciences();
        setupEventListeners();
    });

    // Setup event listeners
    function setupEventListeners() {
        // Profile dropdown toggle
        document.getElementById('userProfile').addEventListener('click', function(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.remove('show');
        });

        // Form submissions
        document.getElementById('updateProfileForm').addEventListener('submit', handleUpdateProfile);
        document.getElementById('addModuleForm').addEventListener('submit', handleAddModule);
        document.getElementById('addTaskForm').addEventListener('submit', handleAddTask);
        document.getElementById('updateTaskForm').addEventListener('submit', handleUpdateTask);
        document.getElementById('addQuestionForm').addEventListener('submit', handleAddQuestion);
        document.getElementById('updateQuestionForm').addEventListener('submit', handleUpdateQuestion);
    }

    // Load user data from localStorage
    function loadUserData() {
        const userDataStr = localStorage.getItem('userData');
        if (!userDataStr) {
            window.location.href = 'login.html';
            return;
        }

        try {
            userData = JSON.parse(userDataStr);
            updateUserProfile();
        } catch (error) {
            console.error('Error parsing user data:', error);
            window.location.href = 'login.html';
        }
    }

    // Update user profile display
    function updateUserProfile() {
        document.getElementById('profileName').textContent = `${userData.firstName} ${userData.lastName}`;
        document.getElementById('profilePhone').textContent = userData.phoneNumber;

        if (userData.image) {
            document.getElementById('profileAvatar').src = userData.image;
        }
    }

    // Load sciences from API
    async function loadSciences() {
        try {
            const response = await fetch('/api/v1/science', {
                headers: {
                    'Authorization': localStorage.getItem('authToken')
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load sciences');
            }

            const sciences = await response.json();
            displaySciences(sciences);
        } catch (error) {
            console.error('Error loading sciences:', error);
            alert('Error loading sciences. Please try again.');
        }
    }

    // Display sciences
    function displaySciences(sciences) {
        const grid = document.getElementById('sciencesGrid');
        grid.innerHTML = '';

        sciences.forEach(science => {
            const card = document.createElement('div');
            card.className = 'science-card';
            card.innerHTML = `
                    <div class="science-name">${science.name}</div>
                    <div class="science-stats">
                        <div class="module-count">${science.modules.length} modules</div>
                    </div>
                    <button class="btn" onclick="viewScienceModules(${science.id}, '${science.name}')">
                        <i class="fas fa-eye"></i> View Details
                    </button>
                `;
            grid.appendChild(card);
        });
    }

    // View science modules
    async function viewScienceModules(scienceId, scienceName) {
        currentScience = { id: scienceId, name: scienceName };

        try {
            const response = await fetch('/api/v1/science', {
                headers: {
                    'Authorization': localStorage.getItem('authToken')
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load science details');
            }

            const sciences = await response.json();
            const science = sciences.find(s => s.id === scienceId);

            if (science) {
                displayModules(science.modules, scienceName);
                updateBreadcrumb([
                    { text: 'Sciences', onclick: 'showSciences()' },
                    { text: scienceName, onclick: null }
                ]);
            }
        } catch (error) {
            console.error('Error loading science modules:', error);
            alert('Error loading modules. Please try again.');
        }
    }

    // Display modules
    function displayModules(modules, scienceName) {
        document.getElementById('sciencesView').style.display = 'none';
        document.getElementById('tasksView').style.display = 'none';
        document.getElementById('questionsView').style.display = 'none';
        document.getElementById('modulesView').style.display = 'block';

        document.getElementById('scienceTitle').textContent = `${scienceName} - Modules`;
        document.getElementById('moduleCount').textContent = `${modules.length} modules`;

        const modulesList = document.getElementById('modulesList');
        modulesList.innerHTML = '';

        modules.forEach(module => {
            const moduleItem = document.createElement('div');
            moduleItem.className = `module-item ${!module.active ? 'inactive' : ''}`;
            moduleItem.innerHTML = `
                    <div class="module-header">
                        <div>
                            <div class="module-name">${module.name}</div>
                            <div class="task-count">${module.taskCount} tasks</div>
                        </div>
                        <div class="module-actions">
                            <button class="btn btn-primary" onclick="viewModuleTasks(${module.id}, '${module.name}')">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                        </div>
                    </div>
                `;
            modulesList.appendChild(moduleItem);
        });
    }

    // View module tasks
    async function viewModuleTasks(moduleId, moduleName) {
        currentModule = { id: moduleId, name: moduleName };

        try {
            const response = await fetch(`/api/v1/module/${moduleId}`, {
                headers: {
                    'Authorization': localStorage.getItem('authToken')
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load module details');
            }

            const moduleDetails = await response.json();
            displayTasks(moduleDetails, moduleName);
            updateBreadcrumb([
                { text: 'Sciences', onclick: 'showSciences()' },
                { text: currentScience.name, onclick: `viewScienceModules(${currentScience.id}, '${currentScience.name}')` },
                { text: moduleName, onclick: null }
            ]);
        } catch (error) {
            console.error('Error loading module tasks:', error);
            alert('Error loading tasks. Please try again.');
        }
    }

    // Display tasks
    function displayTasks(moduleDetails, moduleName) {
        document.getElementById('sciencesView').style.display = 'none';
        document.getElementById('modulesView').style.display = 'none';
        document.getElementById('questionsView').style.display = 'none';
        document.getElementById('tasksView').style.display = 'block';

        document.getElementById('moduleTitle').textContent = `${moduleName} - Tasks`;
        document.getElementById('taskCount').textContent = `${moduleDetails.tasks.length} tasks`;

        // Update module status button
        const statusBtn = document.getElementById('moduleStatusBtn');
        if (moduleDetails.active === false) {
            statusBtn.innerHTML = '<i class="fas fa-eye"></i> Present to Mentors';
            statusBtn.className = 'btn btn-success';
        } else {
            statusBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Remove from Mentors';
            statusBtn.className = 'btn btn-danger';
        }

        const tasksList = document.getElementById('tasksList');
        tasksList.innerHTML = '';

        moduleDetails.tasks.forEach(task => {
            const taskItem = document.createElement('div');
            taskItem.className = 'task-item';
            taskItem.innerHTML = `
                    <div>
                        <div class="task-name">${task.taskName}</div>
                        <div class="task-count">Status: ${task.active ? 'Active' : 'Inactive'}</div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="viewTaskQuestions(${task.id}, '${task.taskName}')">
                            <i class="fas fa-eye"></i> View Details
                        </button>
                    </div>
                `;
            tasksList.appendChild(taskItem);
        });
    }

    // View task questions
    async function viewTaskQuestions(taskId, taskName) {
        currentTask = { id: taskId, name: taskName };

        try {
            const response = await fetch(`/api/v1/task/${taskId}`, {
                headers: {
                    'Authorization': localStorage.getItem('authToken')
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load task details');
            }

            const taskDetails = await response.json();
            await displayQuestions(taskDetails, taskName);
            updateBreadcrumb([
                { text: 'Sciences', onclick: 'showSciences()' },
                { text: currentScience.name, onclick: `viewScienceModules(${currentScience.id}, '${currentScience.name}')` },
                { text: currentModule.name, onclick: `viewModuleTasks(${currentModule.id}, '${currentModule.name}')` },
                { text: taskName, onclick: null }
            ]);
        } catch (error) {
            console.error('Error loading task questions:', error);
            alert('Error loading questions. Please try again.');
        }
    }

    // Display questions
    async function displayQuestions(taskDetails, taskName) {
        document.getElementById('sciencesView').style.display = 'none';
        document.getElementById('modulesView').style.display = 'none';
        document.getElementById('tasksView').style.display = 'none';
        document.getElementById('questionsView').style.display = 'block';

        document.getElementById('taskTitle').textContent = `${taskName} - Questions`;
        document.getElementById('questionCount').textContent = `${taskDetails.questionRes.length} questions`;

        // Display task details
        const taskDetailsDiv = document.getElementById('taskDetails');
        let taskDetailsHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4>Task Information</h4>
                    <p><strong>Name:</strong> ${taskDetails.name}</p>
                    <p><strong>Status:</strong> ${taskDetails.active ? 'Active' : 'Inactive'}</p>
            `;

        if (taskDetails.youtubeURL) {
            taskDetailsHTML += `<p><strong>YouTube URL:</strong> <a href="${taskDetails.youtubeURL}" target="_blank">${taskDetails.youtubeURL}</a></p>`;
        }

        if (taskDetails.attachmentId && taskDetails.attachmentId.length > 0) {
            taskDetailsHTML += `<p><strong>Attachments:</strong></p><div class="attachment-preview" id="taskAttachmentsList"></div>`;
        }

        taskDetailsHTML += `</div>`;
        taskDetailsDiv.innerHTML = taskDetailsHTML;

        // Load and display attachments
        if (taskDetails.attachmentId && taskDetails.attachmentId.length > 0) {
            await loadTaskAttachments(taskDetails.attachmentId);
        }

        // Display questions
        const questionsList = document.getElementById('questionsList');
        questionsList.innerHTML = '';

        taskDetails.questionRes.forEach(question => {
            const questionItem = document.createElement('div');
            questionItem.className = 'question-item';
            questionItem.innerHTML = `
                    <div class="question-text">${question.questionTest}</div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                        <button class="btn btn-primary" onclick="viewQuestionDetails(${question.id})">
                            <i class="fas fa-eye"></i> View Details
                        </button>
                        <button class="btn btn-warning" onclick="openUpdateQuestion(${question.id})">
                            <i class="fas fa-edit"></i> Update
                        </button>
                    </div>
                `;
            questionsList.appendChild(questionItem);
        });
    }

    // Load task attachments
    async function loadTaskAttachments(attachmentIds) {
        try {
            const params = new URLSearchParams();
            attachmentIds.forEach(id => params.append('attachmentIds', id));

            const response = await fetch(`/api/v1/attachments?${params}`, {
                headers: {
                    'Authorization': localStorage.getItem('authToken')
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load attachments');
            }

            const attachments = await response.json();
            displayTaskAttachments(attachments);
        } catch (error) {
            console.error('Error loading attachments:', error);
        }
    }

    // Display task attachments
    function displayTaskAttachments(attachments) {
        const container = document.getElementById('taskAttachmentsList');
        if (!container) return;

        container.innerHTML = '';
        attachments.forEach(attachment => {
            const attachmentDiv = document.createElement('div');
            attachmentDiv.className = 'attachment-item';

            const blob = new Blob([new Uint8Array(attachment.content)], { type: attachment.contentType });
            const url = URL.createObjectURL(blob);

            attachmentDiv.innerHTML = `
                    <img src="${url}" alt="Attachment" class="attachment-image">
                `;
            container.appendChild(attachmentDiv);
        });
    }

    // View question details
    async function viewQuestionDetails(questionId) {
        try {
            const response = await fetch(`/api/v1/questions/${questionId}`, {
                headers: {
                    'Authorization': localStorage.getItem('authToken')
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load question details');
            }

            const question = await response.json();
            displayQuestionDetails(question);
        } catch (error) {
            console.error('Error loading question details:', error);
            alert('Error loading question details. Please try again.');
        }
    }

    // Display question details
    function displayQuestionDetails(question) {
        let detailsHTML = `
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #ffc107;">
                    <h4>Question Details</h4>
                    <p><strong>Question:</strong> ${question.questionTest}</p>
                    <p><strong>Variants:</strong></p>
                    <ul>
            `;

        question.variant.forEach((variant, index) => {
            const isCorrect = variant === question.currentAnswer;
            detailsHTML += `<li style="color: ${isCorrect ? 'green' : 'black'}; font-weight: ${isCorrect ? 'bold' : 'normal'};">${variant} ${isCorrect ? '(Correct Answer)' : ''}</li>`;
        });

        detailsHTML += `</ul>`;

        if (question.attachmentId) {
            detailsHTML += `<div id="questionAttachmentDisplay"></div>`;
        }

        detailsHTML += `</div>`;

        // Insert after the question item
        const questionItems = document.querySelectorAll('.question-item');
        questionItems.forEach(item => {
            const existingDetails = item.nextElementSibling;
            if (existingDetails && existingDetails.classList.contains('question-details')) {
                existingDetails.remove();
            }
        });

        const questionItem = Array.from(questionItems).find(item =>
            item.innerHTML.includes(`viewQuestionDetails(${question.id})`)
        );

        if (questionItem) {
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'question-details';
            detailsDiv.innerHTML = detailsHTML;
            questionItem.parentNode.insertBefore(detailsDiv, questionItem.nextSibling);

            // Load attachment if exists
            if (question.attachmentId) {
                loadQuestionAttachment(question.attachmentId);
            }
        }
    }

    // Load question attachment
    async function loadQuestionAttachment(attachmentId) {
        try {
            const response = await fetch(`/api/v1/attachments/${attachmentId}`, {
                headers: {
                    'Authorization': localStorage.getItem('authToken')
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load attachment');
            }

            const attachment = await response.json();
            const container = document.getElementById('questionAttachmentDisplay');
            if (container) {
                const blob = new Blob([new Uint8Array(attachment.content)], { type: attachment.contentType });
                const url = URL.createObjectURL(blob);

                container.innerHTML = `
                        <p><strong>Attachment:</strong></p>
                        <img src="${url}" alt="Question Attachment" style="max-width: 300px; border-radius: 8px;">
                    `;
            }
        } catch (error) {
            console.error('Error loading question attachment:', error);
        }
    }

    // Navigation functions
    function showSciences() {
        document.getElementById('sciencesView').style.display = 'block';
        document.getElementById('modulesView').style.display = 'none';
        document.getElementById('tasksView').style.display = 'none';
        document.getElementById('questionsView').style.display = 'none';
        updateBreadcrumb([{ text: 'Sciences', onclick: null }]);
    }

    // Update breadcrumb
    function updateBreadcrumb(items) {
        const breadcrumb = document.getElementById('breadcrumb');
        breadcrumb.innerHTML = '';

        items.forEach((item, index) => {
            if (index > 0) {
                const separator = document.createElement('span');
                separator.className = 'breadcrumb-separator';
                separator.innerHTML = '<i class="fas fa-chevron-right"></i>';
                breadcrumb.appendChild(separator);
            }

            const breadcrumbItem = document.createElement('a');
            breadcrumbItem.className = 'breadcrumb-item';
            breadcrumbItem.textContent = item.text;

            if (item.onclick) {
                breadcrumbItem.href = '#';
                breadcrumbItem.onclick = () => eval(item.onclick);
            } else {
                breadcrumbItem.style.color = '#999';
                breadcrumbItem.style.cursor = 'default';
            }

            breadcrumb.appendChild(breadcrumbItem);
        });
    }

    // Modal functions
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // Profile functions
    function openUpdateProfile() {
        document.getElementById('updateFirstName').value = userData.firstName;
        document.getElementById('updateLastName').value = userData.lastName;
        document.getElementById('updatePhoneNumber').value = userData.phoneNumber;
        document.getElementById('updatePassword').value = '';

        if (userData.image) {
            document.getElementById('profileImagePreview').innerHTML = `
                    <div class="attachment-item">
                        <img src="${userData.image}" alt="Current Profile" class="attachment-image">
                    </div>
                `;
        }

        openModal('updateProfileModal');
    }

    function previewProfileImage(input) {
        const preview = document.getElementById('profileImagePreview');
        preview.innerHTML = '';

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `
                        <div class="attachment-item">
                            <img src="${e.target.result}" alt="Profile Preview" class="attachment-image">
                        </div>
                    `;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function handleUpdateProfile(e) {
        e.preventDefault();

        const loading = document.getElementById('updateProfileLoading');
        loading.style.display = 'inline-block';

        try {
            const formData = new FormData();
            formData.append('id', userData.userId);
            formData.append('firstName', document.getElementById('updateFirstName').value);
            formData.append('lastName', document.getElementById('updateLastName').value);
            formData.append('phoneNumber', document.getElementById('updatePhoneNumber').value);

            const password = document.getElementById('updatePassword').value;
            if (password) {
                formData.append('password', password);
            }

            const fileInput = document.getElementById('profileImageInput');
            if (fileInput.files && fileInput.files[0]) {
                formData.append('file', fileInput.files[0]);
            }

            const response = await fetch('/api/v1/auth/updateProfile', {
                method: 'POST',
                headers: {
                    'Authorization': localStorage.getItem('authToken')
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error('Failed to update profile');
            }

            const result = await response.json();

            // Update localStorage
            userData.firstName = result.firstName;
            userData.lastName = result.lastName;
            userData.phoneNumber = result.phoneNumber;
            if (result.image) {
                userData.image = result.image;
            }

            localStorage.setItem('userData', JSON.stringify(userData));
            updateUserProfile();

            closeModal('updateProfileModal');
            alert('Profile updated successfully!');
        } catch (error) {
            console.error('Error updating profile:', error);
            alert('Error updating profile. Please try again.');
        } finally {
            loading.style.display = 'none';
        }
    }

    function logout() {
        const roles = userData.roles;
        localStorage.removeItem('authToken');
        localStorage.removeItem('userData');

        if (Array.isArray(roles) && roles.length > 1) {
            window.location.href = 'chooseRole.html';
        } else {
            window.location.href = 'index.html';
        }
    }

    // Module functions
    function openAddModule() {
        document.getElementById('moduleName').value = '';
        openModal('addModuleModal');
    }

    async function handleAddModule(e) {
        e.preventDefault();

        const loading = document.getElementById('addModuleLoading');
        loading.style.display = 'inline-block';

        try {
            const moduleReq = {
                name: document.getElementById('moduleName').value,
                scienceId: currentScience.id
            };

            const response = await fetch('/api/v1/module', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': localStorage.getItem('authToken')
                },
                body: JSON.stringify(moduleReq)
            });

            if (!response.ok) {
                throw new Error('Failed to create module');
            }

            const result = await response.json();
            closeModal('addModuleModal');
            alert('Module created successfully!');

            // Refresh modules view
            viewScienceModules(currentScience.id, currentScience.name);
        } catch (error) {
            console.error('Error creating module:', error);
            alert('Error creating module. Please try again.');
        } finally {
            loading.style.display = 'none';
        }
    }

    async function toggleModuleStatus() {
        if (!currentModule) return;

        try {
            // Get current module status first
            const moduleResponse = await fetch(`/api/v1/module/${currentModule.id}`, {
                headers: {
                    'Authorization': localStorage.getItem('authToken')
                }
            });

            if (!moduleResponse.ok) {
                throw new Error('Failed to get module status');
            }

            const moduleDetails = await moduleResponse.json();

            let response;
            if (moduleDetails.active === false) {
                // Present to mentors (activate)
                response = await fetch(`/api/v1/module/${currentModule.id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': localStorage.getItem('authToken')
                    }
                });
            } else {
                // Remove from mentors (deactivate)
                response = await fetch(`/api/v1/module/${currentModule.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': localStorage.getItem('authToken')
                    }
                });
            }

            if (!response.ok) {
                throw new Error('Failed to update module status');
            }

            alert('Module status updated successfully!');

            // Refresh tasks view
            viewModuleTasks(currentModule.id, currentModule.name);
        } catch (error) {
            console.error('Error updating module status:', error);
            alert('Error updating module status. Please try again.');
        }
    }

    // Task functions
    function openAddTask() {
        document.getElementById('taskName').value = '';
        document.getElementById('youtubeURL').value = '';
        document.getElementById('taskAttachmentsPreview').innerHTML = '';
        openModal('addTaskModal');
    }

    function previewTaskAttachments(input) {
        const preview = document.getElementById('taskAttachmentsPreview');
        preview.innerHTML = '';

        if (input.files) {
            Array.from(input.files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const attachmentDiv = document.createElement('div');
                    attachmentDiv.className = 'attachment-item';
                    attachmentDiv.innerHTML = `
                            <img src="${e.target.result}" alt="Attachment ${index + 1}" class="attachment-image">
                            <button type="button" class="attachment-remove" onclick="removeTaskAttachment(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    preview.appendChild(attachmentDiv);
                };
                reader.readAsDataURL(file);
            });
        }
    }

    function removeTaskAttachment(index) {
        const input = document.getElementById('taskAttachments');
        const dt = new DataTransfer();

        Array.from(input.files).forEach((file, i) => {
            if (i !== index) {
                dt.items.add(file);
            }
        });

        input.files = dt.files;
        previewTaskAttachments(input);
    }

    async function handleAddTask(e) {
        e.preventDefault();

        const loading = document.getElementById('addTaskLoading');
        loading.style.display = 'inline-block';

        try {
            const formData = new FormData();
            formData.append('taskName', document.getElementById('taskName').value);
            formData.append('youtubeURL', document.getElementById('youtubeURL').value);
            formData.append('moduleId', currentModule.id);
            formData.append('active', true);

            const attachments = document.getElementById('taskAttachments').files;
            Array.from(attachments).forEach(file => {
                formData.append('attachments', file);
            });

            const response = await fetch('/api/v1/task', {
                method: 'POST',
                headers: {
                    'Authorization': localStorage.getItem('authToken')
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error('Failed to create task');
            }

            const result = await response.json();
            closeModal('addTaskModal');
            alert('Task created successfully!');

            // Refresh tasks view
            viewModuleTasks(currentModule.id, currentModule.name);
        } catch (error) {
            console.error('Error creating task:', error);
            alert('Error creating task. Please try again.');
        } finally {
            loading.style.display = 'none';
        }
    }

    function openUpdateTask() {
        if (!currentTask) return;

        // Load current task data
        fetch(`/api/v1/task/${currentTask.id}`, {
            headers: {
                'Authorization': localStorage.getItem('authToken')
            }
        })
            .then(response => response.json())
            .then(taskDetails => {
                document.getElementById('updateTaskName').value = taskDetails.name;
                document.getElementById('updateYoutubeURL').value = taskDetails.youtubeURL || '';

                // Load current attachments
                if (taskDetails.attachmentId && taskDetails.attachmentId.length > 0) {
                    loadCurrentTaskAttachments(taskDetails.attachmentId);
                }

                document.getElementById('updateTaskAttachmentsPreview').innerHTML = '';
                openModal('updateTaskModal');
            })
            .catch(error => {
                console.error('Error loading task details:', error);
                alert('Error loading task details. Please try again.');
            });
    }

    async function loadCurrentTaskAttachments(attachmentIds) {
        try {
            const params = new URLSearchParams();
            attachmentIds.forEach(id => params.append('attachmentIds', id));

            const response = await fetch(`/api/v1/attachments?${params}`, {
                headers: {
                    'Authorization': localStorage.getItem('authToken')
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load current attachments');
            }

            const attachments = await response.json();
            const container = document.getElementById('currentAttachments');
            container.innerHTML = '';

            attachments.forEach(attachment => {
                const attachmentDiv = document.createElement('div');
                attachmentDiv.className = 'attachment-item';

                const blob = new Blob([new Uint8Array(attachment.content)], { type: attachment.contentType });
                const url = URL.createObjectURL(blob);

                attachmentDiv.innerHTML = `
                        <img src="${url}" alt="Current Attachment" class="attachment-image">
                    `;
                container.appendChild(attachmentDiv);
            });
        } catch (error) {
            console.error('Error loading current attachments:', error);
        }
    }

    function previewUpdateTaskAttachments(input) {
        const preview = document.getElementById('updateTaskAttachmentsPreview');
        preview.innerHTML = '';

        if (input.files) {
            Array.from(input.files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const attachmentDiv = document.createElement('div');
                    attachmentDiv.className = 'attachment-item';
                    attachmentDiv.innerHTML = `
                            <img src="${e.target.result}" alt="New Attachment ${index + 1}" class="attachment-image">
                            <button type="button" class="attachment-remove" onclick="removeUpdateTaskAttachment(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    preview.appendChild(attachmentDiv);
                };
                reader.readAsDataURL(file);
            });
        }
    }

    function removeUpdateTaskAttachment(index) {
        const input = document.getElementById('updateTaskAttachments');
        const dt = new DataTransfer();

        Array.from(input.files).forEach((file, i) => {
            if (i !== index) {
                dt.items.add(file);
            }
        });

        input.files = dt.files;
        previewUpdateTaskAttachments(input);
    }

    async function handleUpdateTask(e) {
        e.preventDefault();

        const loading = document.getElementById('updateTaskLoading');
        loading.style.display = 'inline-block';

        try {
            const formData = new FormData();
            formData.append('taskName', document.getElementById('updateTaskName').value);
            formData.append('youtubeURL', document.getElementById('updateYoutubeURL').value);
            formData.append('moduleId', currentModule.id);
            formData.append('active', true);

            const attachments = document.getElementById('updateTaskAttachments').files;
            Array.from(attachments).forEach(file => {
                formData.append('attachments', file);
            });

            const response = await fetch(`/api/v1/task/${currentTask.id}`, {
                method: 'POST',
                headers: {
                    'Authorization': localStorage.getItem('authToken')
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error('Failed to update task');
            }

            closeModal('updateTaskModal');
            alert('Task updated successfully!');

            // Refresh questions view
            viewTaskQuestions(currentTask.id, currentTask.name);
        } catch (error) {
            console.error('Error updating task:', error);
            alert('Error updating task. Please try again.');
        } finally {
            loading.style.display = 'none';
        }
    }

    // Question functions
    function openAddQuestion() {
        document.getElementById('questionText').value = '';
        document.getElementById('questionAttachmentPreview').innerHTML = '';

        // Reset variants
        const variantsList = document.getElementById('variantsList');
        variantsList.innerHTML = `
                <div class="variant-item">
                    <input type="text" class="variant-input" placeholder="Variant 1" required>
                    <input type="radio" name="correctAnswer" value="0" required>
                    <label>Correct</label>
                    <button type="button" class="btn btn-danger" onclick="removeVariant(this)" style="padding: 5px 10px; font-size: 12px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="variant-item">
                    <input type="text" class="variant-input" placeholder="Variant 2" required>
                    <input type="radio" name="correctAnswer" value="1" required>
                    <label>Correct</label>
                    <button type="button" class="btn btn-danger" onclick="removeVariant(this)" style="padding: 5px 10px; font-size: 12px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

        openModal('addQuestionModal');
    }

    function addVariant() {
        const variantsList = document.getElementById('variantsList');
        const variantCount = variantsList.children.length;

        const variantDiv = document.createElement('div');
        variantDiv.className = 'variant-item';
        variantDiv.innerHTML = `
                <input type="text" class="variant-input" placeholder="Variant ${variantCount + 1}" required>
                <input type="radio" name="correctAnswer" value="${variantCount}" required>
                <label>Correct</label>
                <button type="button" class="btn btn-danger" onclick="removeVariant(this)" style="padding: 5px 10px; font-size: 12px;">
                    <i class="fas fa-trash"></i>
                </button>
            `;

        variantsList.appendChild(variantDiv);
    }

    function removeVariant(button) {
        const variantsList = document.getElementById('variantsList');
        if (variantsList.children.length > 2) {
            button.parentElement.remove();

            // Update radio button values and placeholders
            Array.from(variantsList.children).forEach((variant, index) => {
                const radio = variant.querySelector('input[type="radio"]');
                const textInput = variant.querySelector('.variant-input');
                radio.value = index;
                textInput.placeholder = `Variant ${index + 1}`;
            });
        } else {
            alert('At least 2 variants are required.');
        }
    }

    function previewQuestionAttachment(input) {
        const preview = document.getElementById('questionAttachmentPreview');
        preview.innerHTML = '';

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `
                        <div class="attachment-item">
                            <img src="${e.target.result}" alt="Question Attachment" class="attachment-image">
                        </div>
                    `;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function handleAddQuestion(e) {
        e.preventDefault();

        const loading = document.getElementById('addQuestionLoading');
        loading.style.display = 'inline-block';

        try {
            // Get variants and correct answer
            const variantInputs = document.querySelectorAll('#variantsList .variant-input');
            const correctAnswerRadio = document.querySelector('input[name="correctAnswer"]:checked');

            if (!correctAnswerRadio) {
                alert('Please select the correct answer.');
                return;
            }

            const variants = Array.from(variantInputs).map(input => input.value.trim()).filter(v => v);
            const correctAnswerIndex = parseInt(correctAnswerRadio.value);
            const correctAnswer = variants[correctAnswerIndex];

            if (variants.length < 2) {
                alert('At least 2 variants are required.');
                return;
            }

            // Upload attachment if exists
            let attachmentId = null;
            const attachmentFile = document.getElementById('questionAttachment').files[0];
            if (attachmentFile) {
                const formData = new FormData();
                formData.append('file', attachmentFile);

                const attachmentResponse = await fetch('/api/v1/attachments', {
                    method: 'POST',
                    headers: {
                        'Authorization': localStorage.getItem('authToken')
                    },
                    body: formData
                });

                if (attachmentResponse.ok) {
                    const attachmentResult = await attachmentResponse.json();
                    attachmentId = attachmentResult.id;
                }
            }

            const questionReq = {
                attachmentId: attachmentId,
                questionTest: document.getElementById('questionText').value,
                variant: variants,
                currentAnswer: correctAnswer,
                taskId: currentTask.id
            };

            const response = await fetch('/api/v1/questions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': localStorage.getItem('authToken')
                },
                body: JSON.stringify(questionReq)
            });

            if (!response.ok) {
                throw new Error('Failed to create question');
            }

            closeModal('addQuestionModal');
            alert('Question created successfully!');

            // Refresh questions view
            viewTaskQuestions(currentTask.id, currentTask.name);
        } catch (error) {
            console.error('Error creating question:', error);
            alert('Error creating question. Please try again.');
        } finally {
            loading.style.display = 'none';
        }
    }

    async function openUpdateQuestion(questionId) {
        currentQuestion = { id: questionId };

        try {
            const response = await fetch(`/api/v1/questions/${questionId}`, {
                headers: {
                    'Authorization': localStorage.getItem('authToken')
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load question details');
            }

            const question = await response.json();

            // Fill form with current data
            document.getElementById('updateQuestionText').value = question.questionTest;

            // Load current attachment
            if (question.attachmentId) {
                loadCurrentQuestionAttachment(question.attachmentId);
            } else {
                document.getElementById('currentQuestionAttachment').innerHTML = '<p>No current attachment</p>';
            }

            // Load variants
            const variantsList = document.getElementById('updateVariantsList');
            variantsList.innerHTML = '';

            question.variant.forEach((variant, index) => {
                const isCorrect = variant === question.currentAnswer;
                const variantDiv = document.createElement('div');
                variantDiv.className = 'variant-item';
                variantDiv.innerHTML = `
                        <input type="text" class="variant-input" placeholder="Variant ${index + 1}" value="${variant}" required>
                        <input type="radio" name="updateCorrectAnswer" value="${index}" ${isCorrect ? 'checked' : ''} required>
                        <label>Correct</label>
                        <button type="button" class="btn btn-danger" onclick="removeUpdateVariant(this)" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                variantsList.appendChild(variantDiv);
            });

            document.getElementById('updateQuestionAttachmentPreview').innerHTML = '';
            openModal('updateQuestionModal');
        } catch (error) {
            console.error('Error loading question details:', error);
            alert('Error loading question details. Please try again.');
        }
    }

    async function loadCurrentQuestionAttachment(attachmentId) {
        try {
            const response = await fetch(`/api/v1/attachments/${attachmentId}`, {
                headers: {
                    'Authorization': localStorage.getItem('authToken')
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load current attachment');
            }

            const attachment = await response.json();
            const container = document.getElementById('currentQuestionAttachment');

            const blob = new Blob([new Uint8Array(attachment.content)], { type: attachment.contentType });
            const url = URL.createObjectURL(blob);

            container.innerHTML = `
                    <div class="attachment-item">
                        <img src="${url}" alt="Current Question Attachment" class="attachment-image">
                    </div>
                `;
        } catch (error) {
            console.error('Error loading current question attachment:', error);
            document.getElementById('currentQuestionAttachment').innerHTML = '<p>Error loading current attachment</p>';
        }
    }

    function addUpdateVariant() {
        const variantsList = document.getElementById('updateVariantsList');
        const variantCount = variantsList.children.length;

        const variantDiv = document.createElement('div');
        variantDiv.className = 'variant-item';
        variantDiv.innerHTML = `
                <input type="text" class="variant-input" placeholder="Variant ${variantCount + 1}" required>
                <input type="radio" name="updateCorrectAnswer" value="${variantCount}" required>
                <label>Correct</label>
                <button type="button" class="btn btn-danger" onclick="removeUpdateVariant(this)" style="padding: 5px 10px; font-size: 12px;">
                    <i class="fas fa-trash"></i>
                </button>
            `;

        variantsList.appendChild(variantDiv);
    }

    function removeUpdateVariant(button) {
        const variantsList = document.getElementById('updateVariantsList');
        if (variantsList.children.length > 2) {
            button.parentElement.remove();

            // Update radio button values and placeholders
            Array.from(variantsList.children).forEach((variant, index) => {
                const radio = variant.querySelector('input[type="radio"]');
                const textInput = variant.querySelector('.variant-input');
                radio.value = index;
                textInput.placeholder = `Variant ${index + 1}`;
            });
        } else {
            alert('At least 2 variants are required.');
        }
    }

    function previewUpdateQuestionAttachment(input) {
        const preview = document.getElementById('updateQuestionAttachmentPreview');
        preview.innerHTML = '';

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `
                        <div class="attachment-item">
                            <img src="${e.target.result}" alt="New Question Attachment" class="attachment-image">
                        </div>
                    `;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function handleUpdateQuestion(e) {
        e.preventDefault();

        const loading = document.getElementById('updateQuestionLoading');
        loading.style.display = 'inline-block';

        try {
            // Get variants and correct answer
            const variantInputs = document.querySelectorAll('#updateVariantsList .variant-input');
            const correctAnswerRadio = document.querySelector('input[name="updateCorrectAnswer"]:checked');

            if (!correctAnswerRadio) {
                alert('Please select the correct answer.');
                return;
            }

            const variants = Array.from(variantInputs).map(input => input.value.trim()).filter(v => v);
            const correctAnswerIndex = parseInt(correctAnswerRadio.value);
            const correctAnswer = variants[correctAnswerIndex];

            if (variants.length < 2) {
                alert('At least 2 variants are required.');
                return;
            }

            // Upload new attachment if exists
            let attachmentId = null;
            const attachmentFile = document.getElementById('updateQuestionAttachment').files[0];
            if (attachmentFile) {
                const formData = new FormData();
                formData.append('file', attachmentFile);

                const attachmentResponse = await fetch('/api/v1/attachments', {
                    method: 'POST',
                    headers: {
                        'Authorization': localStorage.getItem('authToken')
                    },
                    body: formData
                });

                if (attachmentResponse.ok) {
                    const attachmentResult = await attachmentResponse.json();
                    attachmentId = attachmentResult.id;
                }
            }

            const questionReq = {
                attachmentId: attachmentId,
                questionTest: document.getElementById('updateQuestionText').value,
                variant: variants,
                currentAnswer: correctAnswer,
                taskId: currentTask.id
            };

            const response = await fetch(`/api/v1/questions/${currentQuestion.id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': localStorage.getItem('authToken')
                },
                body: JSON.stringify(questionReq)
            });

            if (!response.ok) {
                throw new Error('Failed to update question');
            }

            closeModal('updateQuestionModal');
            alert('Question updated successfully!');

            // Refresh questions view
            viewTaskQuestions(currentTask.id, currentTask.name);
        } catch (error) {
            console.error('Error updating question:', error);
            alert('Error updating question. Please try again.');
        } finally {
            loading.style.display = 'none';
        }
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    }
</script>
</body>
</html>
